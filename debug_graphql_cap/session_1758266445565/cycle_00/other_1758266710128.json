;/*FB_PKG_DELIM*/

__d("FtsFetchEbMessagesEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6752");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6753");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6754");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchEbMessagesStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6755");b=d("FalcoLoggerInternal").create("fts_fetch_eb_messages_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6776");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageEndFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6777");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_end",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsPageStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6778");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_page_start",a);e=b;g["default"]=e}),98);
__d("FtsFetchOccamThreadsStartFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("6779");b=d("FalcoLoggerInternal").create("fts_fetch_occam_threads_start",a);e=b;g["default"]=e}),98);
__d("LSFetchFtsThreads",["LSIssueNewTask"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return d[0]=new c.Map(),d[0].set("timestamp",a[0]),d[0].set("session_id",a[1]),d[1]=c.toJSON(d[0]),c.storedProcedure(b("LSIssueNewTask"),"fts_thread_fetch",c.i64.cast([0,760]),d[1],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return c.resolve(e)}])}a.__sproc_name__="LSFTSThreadsFetchFtsThreadsStoredProcedure";a.__tables__=[];e.exports=a}),null);
__d("LSFetchFtsThreadsStoredProcedure",["LSFetchFtsThreads","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSFetchFtsThreads"),e.timestamp,e.sessionId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSIssueFetchAndIndexMessageRangeTask",["LSArrayGetObjectAt","LSBase64Encode.nop","LSIsEncryptionVersionSecure","LSIssueNewTask","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] Beginning execution."),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[13]=new c.Map(),d[13].set("error_msg","Expected a nonempty query result"),d[13].set("code",c.i64.cast([0,3])),d[13].set("src_line","MEBClientStateUtils.php:256 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[14]=c.createArray(),d[15]=(d[14].push(d[13]),d[14]),e=[void 0,d[14]],d[1]=e[0],d[2]=e[1]):(b=a.item,d[13]=new c.Map(),d[13].set("backup_id",b.backupId),d[13].set("device_public_key_blob",b.devicePublicKeyBlob),d[13].set("device_private_key_blob",b.devicePrivateKeyBlob),d[13].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[13].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[13].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[13].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[13].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[13].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[13].set("orf_client_state_v2_blob",void 0),d[13].set("orf_v2_authority_level",void 0),d[13].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[13].set("device_id",b.deviceId),d[13].set("backup_tenancy",b.backupTenancy),d[13].set("encryption_version",b.encryptionVersion),d[13].set("revision_version",b.revisionVersion),d[13].set("initialize_restore_result",void 0),d[13].set("device_creation_timestamp_sec",void 0),d[13].set("authority_level",b.authorityLevel),e=[d[13],void 0],d[1]=e[0],d[2]=e[1])})},function(e){return d[4]=new c.Map(),d[4].set("value",d[1]),d[4].set("errors",d[2]),d[5]=d[4].get("value"),d[5]!==void 0?c.sequence([function(e){return d[13]=d[5].get("backup_id"),d[14]=d[5].get("device_public_key_blob"),d[15]=d[5].get("device_private_key_blob"),d[16]=d[5].get("epoch_storage_public_key_blob"),d[17]=d[5].get("epoch_storage_private_key_blob"),d[18]=d[5].get("epoch_auth_public_key_blob"),d[19]=d[5].get("epoch_auth_private_key_blob"),d[20]=d[5].get("mailbox_root_key_blob"),d[21]=d[5].get("ocmf_client_state_blob"),d[22]=d[5].get("orf_client_state_v2_blob"),d[23]=d[5].get("orf_v2_authority_level"),d[24]=d[5].get("oblivious_validation_token_blob"),d[25]=d[5].get("device_id"),d[26]=d[5].get("backup_tenancy"),d[27]=d[5].get("encryption_version"),d[28]=d[5].get("revision_version"),d[29]=d[5].get("initialize_restore_result"),d[30]=d[5].get("device_creation_timestamp_sec"),d[31]=d[5].get("authority_level"),c.i64.neq(d[25],void 0)?c.sequence([function(a){return d[33]=void 0,c.i64.neq(d[33],void 0)?c.resolve(d[34]=d[33]):c.sequence([function(a){return d[53]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[54]?d[63]=(d[53].push(c.i64.cast([0,0])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[55]=a[0],a})},function(a){return d[55]?d[63]=(d[53].push(c.i64.cast([0,2])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[56]=a[0],a})},function(a){return d[56]?d[63]=(d[53].push(c.i64.cast([0,3])),d[53]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[57]?d[63]=(d[53].push(c.i64.cast([0,4])),d[53]):0,d[58]=c.createArray(),d[59]=c.i64.of_int32(d[53].length),c.i64.gt(d[59],c.i64.cast([0,0]))?c.loopAsync(d[59],function(a){return d[63]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],d[63]).then(function(a){return a=a,d[64]=a[0],d[65]=a[1],a})},function(a){return d[66]=(d[58].push(d[64]),d[58])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[63]=c.createArray(),d[64]=c.i64.of_int32(d[58].length),c.i64.gt(d[64],c.i64.cast([0,0]))?c.loopAsync(d[64],function(a){return d[66]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[58],d[66]).then(function(a){return a=a,d[67]=a[0],d[68]=a[1],a})},function(a){return d[69]=(d[63].push(c.i64.to_string(d[67])),d[63])}])}):c.resolve()},function(a){return d[65]=d[63].join(","),d[60]=d[65]}])},function(a){return d[58].some(function(a){return c.i64.eq(d[27],a)})?d[61]=d[27]:d[61]=void 0,c.i64.neq(d[61],void 0)?d[62]=d[61]:d[62]=void 0,d[34]=d[62]}])},function(a){return c.i64.neq(d[34],void 0)?d[35]=d[34]:d[35]=c.i64.cast([0,0]),c.i64.neq(d[26],void 0)?d[36]=d[26]:d[36]=c.i64.cast([0,1]),c.i64.eq(d[36],c.i64.cast([0,3]))?d[37]=c.i64.cast([0,4]):d[37]=c.i64.cast([0,0]),c.nativeOperation(b("LSBase64Encode.nop"),d[21]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[20]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[40]=new c.Map(),d[40].set("ocmf_client_state_blob",d[38]==null?"":d[38]),d[40].set("mailbox_root_key",d[39]==null?"":d[39]),d[41]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[53]=(d[41].push(a.epochId),d[41])})},function(a){return d[51]="Queried locally available epochs. Count: ",d[42]=c.i64.of_int32(d[41].length),d[52]=c.i64.to_string(d[42]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBEpochClientUtils] ",d[43],d[51],d[43],d[52]].join("")),c.resolve()},function(e){return d[44]=new c.Map(),d[44].set("device_id",d[25]),d[44].set("raw_tokens",d[40]),d[44].set("locally_available_epochs",d[41]),d[45]=new c.Map(),d[45].set("act_thread_id",a[0]),d[45].set("request_id",a[3]),d[45].set("tam_thread_subtype",d[37]),d[45].set("source",c.i64.cast([0,43])),d[46]=new c.Map(),d[46].set("reference_timestamp",a[2]),d[46].set("direction",c.i64.cast([0,1])),d[46].set("server_thread_key",void 0),d[46].set("device_context",d[44]),d[46].set("source",c.i64.cast([0,43])),d[47]=new c.Map(),d[47].set("restore_context",d[45]),d[47].set("success",d[46]),d[48]=d[47].get("queue_name"),d[48]!==void 0?d[49]=d[48]:(d[53]=d[47].get("restore_context"),d[54]=d[53].get("act_thread_id"),d[49]=["encrypted_backups_restore",":",d[54]].join("")),d[50]=c.toJSON(d[47]),c.storedProcedure(b("LSIssueNewTask"),d[49],c.i64.cast([0,50030]),d[50],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[32]=!0}]):c.sequence([function(e){return d[33]=new c.Map(),d[33].set("error_code",c.i64.cast([0,1])),d[33].set("error_message",void 0==null?"":void 0),d[33].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[34]=new c.Map(),d[34].set("act_thread_id",a[0]),d[34].set("source",c.i64.cast([0,43])),d[34].set("restore_operation_type",c.i64.cast([0,2])),d[34].set("request_id",void 0),d[34].set("device_id",void 0),d[35]=new c.Map(),d[35].set("restore_context",d[34]),d[35].set("failure",d[33]),d[36]=d[35].get("queue_name"),d[36]!==void 0?d[37]=d[36]:(d[40]=d[35].get("restore_context"),d[41]=d[40].get("act_thread_id"),d[37]=["encrypted_backups_restore",":",d[41]].join("")),d[38]=c.toJSON(d[35]),c.storedProcedure(b("LSIssueNewTask"),d[37],c.i64.cast([0,50030]),d[38],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[39]="backup not found",d[39]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[39]].join("")),d[40]=c.createArray(),void 0!==void 0?d[41]=(d[40].push(void 0),d[40]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[39],d[40],c.i64.cast([0,3]))):c.resolve()},function(a){return d[32]=!1}])},function(a){return d[6]=d[32]}]):c.sequence([function(e){return d[13]=d[4].get("errors"),d[14]=d[4].get("errors"),d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,1])),d[15].set("error_message",void 0==null?"":void 0),d[15].set("stored_procedure","issueFetchAndIndexMessageRangeTask"),d[16]=new c.Map(),d[16].set("act_thread_id",a[0]),d[16].set("source",c.i64.cast([0,43])),d[16].set("restore_operation_type",c.i64.cast([0,2])),d[16].set("request_id",void 0),d[16].set("device_id",void 0),d[17]=new c.Map(),d[17].set("restore_context",d[16]),d[17].set("failure",d[15]),d[18]=d[17].get("queue_name"),d[18]!==void 0?d[19]=d[18]:(d[22]=d[17].get("restore_context"),d[23]=d[22].get("act_thread_id"),d[19]=["encrypted_backups_restore",":",d[23]].join("")),d[20]=c.toJSON(d[17]),c.storedProcedure(b("LSIssueNewTask"),d[19],c.i64.cast([0,50030]),d[20],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(a){return d[21]="backup not found",d[21]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ","",d[21]].join("")),d[22]=c.createArray(),void 0!==void 0?d[23]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",d[21],d[22],c.i64.cast([0,3]))):c.resolve()},function(a){return d[6]=!1}])},function(a){return d[7]=c.i64.of_float(Date.now()),d[8]=c.i64.random(),d[10]="Finishing execution. Execution time: ",d[11]=c.i64.to_string(c.i64.sub(d[7],d[0])),d[12]=" ms",d[9]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure] ",d[9],d[10],d[9],d[11],d[9],d[12]].join("")),c.i64.eq(c.i64.mod_(d[8],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[13]=",",d[14]=c.createArray(),void 0!==void 0?d[15]=(d[14].push(void 0),d[14]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure",[d[10],d[13],d[11],d[13],d[12]].join(""),d[14],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsIssueFetchAndIndexMessageRangeTaskStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure",["LSIssueFetchAndIndexMessageRangeTask","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSIssueFetchAndIndexMessageRangeTask"),e.threadId,e.numMessages,e.startSortKey,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWFTSEncryptedBackupLightweightRestore",["EBIsEbEnabled","LSFactory","LSIssueFetchAndIndexMessageRangeTaskStoredProcedure","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MAWBridgeSendAndReceive","MAWEBRestoreTrackingUtils","MAWMainTraceUtils","MAWMpsGating","MWEncryptedBackUpEBNotEnabledError","Promise","emptyFunction","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,e,f,g,j,k){j===void 0&&(j=c("emptyFunction"));if(!c("gkx")("23914"))return null;var l=d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("EBIsEbEnabled").isEbEnabledLS(a.tables).then(function(m){if(!m){d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(l,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(h||(h=b("Promise"))).resolve()}return i(l,a,e,f,g,j,k)}));return l}function i(a,e,g,i,j,k,l){k===void 0&&(k=c("emptyFunction"));k();return d("MAWMpsGating").isFullMpsEnabled()?d("MAWBridgeSendAndReceive").sendAndReceive("backend","issueGraphQLRangeRestoreRequest",{chatJid:l,direction:"before",sortOrderMs:i!=null?i:void 0,source:c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB,threadId:g,traceId:a}).then(function(e){if(e.loadMessagesResponse!=null)d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(a,e.loadMessagesResponse);else{d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(a,c("err")((e=e.error)!=null?e:"Error restoring from EB over graphQL in worker"))}return(h||(h=b("Promise"))).resolve()}):e.runInTransaction(function(b){d("MAWEBRestoreTrackingUtils").markEBRestoreSearch({querySource:"LS",traceId:a});return c("LSIssueFetchAndIndexMessageRangeTaskStoredProcedure")(c("LSFactory")(b),{numMessages:j,startSortKey:i==null?void 0:i,threadId:g,traceId:a})},"readwrite",void 0,void 0,f.id+":105")}g.runQuery=a}),98);
__d("MAWAsyncEBIssueFetchAndIndexFTSQuery",["I64","MAWAsyncEBPendingQueryPromise","MAWEBUnstoredDbMsgUtils","MAWFTSEncryptedBackupLightweightRestore","MAWJobDefinitions","MAWMpsGating","MAWUserJidWrapper","MpsOverBridge","MpsTypes","WAJids","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e,f,g,i){g===void 0&&(g=function(){});var j=d("WAJids").threadIdForChatJid(b);if(d("MAWMpsGating").isSearchOnMpsEnabled()||d("MAWMpsGating").isFullMpsEnabled()){var k=e==null?Date.now()+6e4:Number(e);g();return d("MpsOverBridge").mps().loadMessages({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!1,shouldFetchTags:!1,shouldIgnoreLocalOnly:!0,strategy:"remote-only"},debug:{purpose:"MAWAsyncEBIssueFetchAndIndexFTSQuery_"+i},direction:"desc",from:[d("MpsTypes").toTimestamp(k),null],numMessages:(h||(h=d("I64"))).to_int32(f),threadId:d("MpsTypes").toThreadId(b)}).then(function(a){var e;if(a.success===!1)throw a.payload||c("err")(a.error);var f=a.value.messages.map(d("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage);e=a.value.cursorInfo.hasNext?(e=a.value.cursorInfo.endCursor)==null?void 0:e[0]:0;return{echoMessages:[],hasMoreAfter:a.value.cursorInfo.hasPrevious,hasMoreBefore:a.value.cursorInfo.hasNext,isPointQuery:!1,messages:d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(f,void 0,b,d("MAWUserJidWrapper").getMyUserJid()),nextMessageTimestampMsBefore:e==null?void 0:(h||(h=d("I64"))).of_float(e),protobufMessages:f,referenceTimestamp:k.toString(),requestId:void 0,restoreType:"protobuf",threadId:j}})}i=d("MAWFTSEncryptedBackupLightweightRestore").runQuery(a,j,e,f,g,b);if(i==null)return null;d("MAWAsyncEBPendingQueryPromise").setJidFromThreadId(j,b);return d("MAWAsyncEBPendingQueryPromise").getPendingQueryPromiseFromTrace(i)}g.issueQueryAsPromise=a}),98);
__d("MAWFTSRestoreCap",["WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";b=c("justknobx")._("1658");e=d("WATimeUtils").DAY_MILLISECONDS*b;var h=Date.now()-e;function a(a){return a>h}g.RESTORE_CAP_DATE_MS=h;g.isRestoreTimeWithinCap=a}),98);
__d("MAWMediaGalleryBufferAndRestore",[],(function(a,b,c,d,e,f){"use strict";var g=null,h=[],i=[],j=[],k=null,l=2e3,m=10;function a(a,b,c,d,e,f,n,o,p,q){q==null||q.addPoint("buffer_and_restore_protobuf_start");var r=function(){h=h.concat(b),i=i.concat(c!=null?c:[]),q!=null&&j.push(q),h.length>=m?(j.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"max_buffer_size"}})}),void p(a,h,i,d,e,f,n,o,j),h=[],i=[],j=[]):k=window.setTimeout(function(){var b=[].concat(h),c=[].concat(i),g=[].concat(j);g.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"timeout"}})});void p(a,b,c,d,e,f,n,o,g);h=[];i=[];j=[]},l)},s=function(){window.clearTimeout(k);var a=h.map(function(a){return a}),b=i.map(function(a){return a}),c=[].concat(j),l=g;l!=null&&(c.forEach(function(a){return a.addPoint("buffer_and_restore_protobuf_end",{string:{reason:"immediately"}})}),void p(l,a,b,d,e,f,n,o,c));h=[];i=[];j=[]};if(a!==g){s();g=a;r();return}h.length===0?r():(h=h.concat(b),i=i.concat(c!=null?c:[]),q!=null&&j.push(q),h.length>=m&&s())}f.bufferAndRestoreProtobuf=a}),66);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["ExecutionEnvironment","LSDatabaseSingleton","LSVec","Promise","WAJobOrchestratorTypes","asyncToGeneratorRuntime","cr:10036","cr:9465","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,e,g,l,m,n,o,p,q,r,s,t){t===void 0&&(t=d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION);return k.load().then(function(){var k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(k){var u=r!=null?Number(r):void 0;u=b("cr:9465")!=null?b("cr:9465").getMessageMetadataFromDeanonAPI(e,g.length,u):(j||(j=b("Promise"))).resolve();var v,w;(i||(i=c("ExecutionEnvironment"))).isInWorker&&b("cr:10036")!=null?(yield b("cr:10036").init(),v=(yield b("cr:10036").getLSStorage())):(v=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton),w=(yield u));return v.runInTransaction(function(b){return k.call(b,a,e,g,l,m,n,o,p,q,r,s,w,t,void 0)},"readwrite",void 0,void 0,f.id+":71").then(function(){return[c("LSVec").ofArray([]),c("LSVec").ofArray([]),!1]})});return function(a){return k.apply(this,arguments)}}())}g.call=a}),98);
__d("MWMediaRestoreStatus",["I64","LSDatabaseSingleton","MAWChatJid","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j={mediaCount:0,messageCount:0,threadId:(h||(h=d("I64"))).zero};function a(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);e=(yield e.runInTransaction(function(b){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(b,(h||(h=d("I64"))).of_string(a))},"readwrite",void 0,void 0,f.id+":35"));j.threadId===e?(j.messageCount+=b,j.mediaCount+=c):(j.messageCount=b,j.mediaCount=c,j.threadId=e!=null?e:(h||(h=d("I64"))).zero)});return k.apply(this,arguments)}function c(){return j}g.updateRestoreStatus=a;g.getRestoreStatus=c}),98);
__d("MAWMediaGalleryRestoreSync",["CurrentUser","EchoMessage","EchoMessageMediaFieldUtils","I64","LSDatabaseSingleton","LSIntEnum","LSMEBTaskCreationSource","LSThreadMediaGalleryGroup","MAWChatJid","MAWFTSRestoreSync","MAWHandleEchoProtobufsRestoreApi","MAWJids","MAWJobDefinitions","MAWMediaGalleryBufferAndRestore","MAWMediaGalleryEBTaggingUtils","MAWRestoreMessagesFromEncryptedBackupsDeferred","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWMediaRestoreStatus","Promise","ReQL","WAJobOrchestratorTypes","WALogger","WAMsgType","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q;function a(a,b){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var g=a.echoMessages,p=a.hasMoreAfter,r=a.hasMoreBefore,t=a.isPointQuery,u=a.protobufMessages,v=a.referenceTimestamp,w=a.requestId,x=a.restoreType,y=a.threadId;if(y==null){e==null||e.endFail("threadId is null");d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: threadId is null"])));return}e==null||e.addAnnotations({string:{restore_type:x}});e==null||e.addPoint("handle_media_restore_sync_start");var z=!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled();if(x==="echo"){var A;if(g==null){e==null||e.endFail("echoMessages is null");d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: echoMessages is null"])));return}e==null||e.addPoint("messages_decoding_and_filtering_start");a=g.filter(function(a){var b;a=d("EchoMessage").decodeEchoMessage(a);return z?(a==null?void 0:a.contentType)===d("EchoMessage").EchoMessageContentType.MEDIA:(a==null||(b=a.mediaData)==null?void 0:b.attachmentType)===d("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT});e==null||e.addPoint("messages_decoding_and_filtering_end");a.length>0&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);e==null||e.addAnnotations({"int":{media_count:a.length,message_count:g.length}});e==null||e.addPoint("update_media_restore_status_start");yield d("MWMediaRestoreStatus").updateRestoreStatus(y,g.length,a.length);e==null||e.addPoint("update_media_restore_status_end");e==null||e.addPoint("restore_messages_in_worker_start",{"int":{echo_msg_count:(A=g==null?void 0:g.length)!=null?A:0,protobuf_msg_count:a.length}});c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(y),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),r,void 0,p,void 0,t,w,v,c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW)["catch"](function(a){e==null||e.endFail(a),d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Echo error: ",""])),a)}),function(){e==null||e.addPoint("restore_messages_in_worker_end"),e==null||e.addPoint("restore_messages_update_ranges_start"),c("promiseDone")((o||(o=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){e==null||e.addPoint("update_range_get_thread_key_start");var g=(yield a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(q||(q=d("I64"))).of_string(y))},"readonly",void 0,void 0,f.id+":151"));e==null||e.addPoint("update_range_get_thread_key_end");if(g==null){e==null||e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}});return}return(n||(n=b("Promise"))).all([s(a,g,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),s(a,g,c("LSThreadMediaGalleryGroup").FILES_ONLY)])});return function(b){return a.apply(this,arguments)}}()).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),e==null||e.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}}),e==null||e.addPoint("handle_media_restore_sync_end"),e==null||e.endSuccess()}))})}else if(x==="protobuf"){if(u==null){e==null||e.endFail("protobufMessages is null");d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore: protobufMessages is null"])));return}e==null||e.addPoint("get_user_jid_start");var B=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());e==null||e.addPoint("get_user_jid_end");e==null||e.addPoint("messages_decoding_and_filtering_start");A=u.filter(function(a){a=d("MAWHandleEchoProtobufsRestoreApi").decodeDecryptedMessageProtobuf(a,B,void 0,new Set(),new Set(),new Map(),new Map(),new Map(),!0);return z&&[d("WAMsgType").MSG_TYPE.IMAGE,d("WAMsgType").MSG_TYPE.VIDEO].includes(a.msgType)||a.msgType===d("WAMsgType").MSG_TYPE.DOCUMENT_FILE});e==null||e.addPoint("messages_decoding_and_filtering_end");A.length>0&&d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!0);e==null||e.addAnnotations({"int":{media_count:A.length,message_count:u.length}});e==null||e.addPoint("update_media_restore_status_start");yield d("MWMediaRestoreStatus").updateRestoreStatus(y,u.length,A.length);e==null||e.addPoint("update_media_restore_status_end");a=function(a,e,g,h,i,j,k,m,p){var r;if(((r=g==null?void 0:g.length)!=null?r:0)===0&&e.length===0){p.forEach(function(a){a.addPoint("restore_messages_in_worker_skipped"),a.endSuccess()});return}p.forEach(function(a){return a.addPoint("restore_messages_in_worker_start",{"int":{echo_msg_count:(a=g==null?void 0:g.length)!=null?a:0,protobuf_msg_count:e.length}})});c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),e,h,void 0,i,void 0,j,k,m,void 0,g,(q||(q=d("I64"))).of_int32(c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE),d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,void 0)["catch"](function(a){p.forEach(function(b){return b.endFail(a)}),d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore Protobuf error: ",""])),a)}),function(){p.forEach(function(a){return a.addPoint("restore_messages_in_worker_end")}),p.forEach(function(a){return a.addPoint("restore_messages_update_ranges_start")}),c("promiseDone")((o||(o=d("LSDatabaseSingleton"))).LSDatabaseSingleton.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){p.forEach(function(a){return a.addPoint("update_range_get_thread_key_start")});var e=(yield a.runInTransaction(function(a){return d("MAWChatJid").toThreadKeyMaybeForChatJidInteger(a,(q||(q=d("I64"))).of_string(y))},"readonly",void 0,void 0,f.id+":314"));p.forEach(function(a){return a.addPoint("update_range_get_thread_key_end")});if(e==null){p.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!1}})});return}return(n||(n=b("Promise"))).all([s(a,e,c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS),s(a,e,c("LSThreadMediaGalleryGroup").FILES_ONLY)])});return function(b){return a.apply(this,arguments)}}()).then(function(){d("MAWFTSRestoreSync").MAWGalleryEventEmitter.emit("isPersisting",!1),p.forEach(function(a){return a.addPoint("restore_messages_update_ranges_end",{bool:{is_updated:!0}})}),p.forEach(function(a){return a.addPoint("handle_media_restore_sync_end")}),p.forEach(function(a){return a.endSuccess()})}))})};d("MAWMediaGalleryBufferAndRestore").bufferAndRestoreProtobuf(y,A,g,r,p,t,w,v,a,e)}else e==null||e.endFail("RestoreType is none"),d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MediaRestore RestoreType is none"])))});return r.apply(this,arguments)}function s(a,c,e){return d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryGroupSupportedForTaggedRestore(e)?(n||(n=b("Promise"))).resolve():a.runInTransaction(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.attachments_ranges_v2__generated).getKeyRange(c).filter(function(a){return(q||(q=d("I64"))).equal(a.mediaGroup,(p||(p=d("LSIntEnum"))).ofNumber(e))})));if(f==null||(f==null?void 0:f.hasMoreBefore)===!0)return;var g=babelHelpers["extends"]({},f,{hasMoreBefore:!0});return b.attachments_ranges_v2__generated.upsert([f.threadKey,f.mediaGroup,f.minTimestampMs],g)});return function(a){return f.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":395")}g.handleMediaRestoreSync=a}),98);
__d("MAWFTSRestoreSyncLogger",["FtsFetchEbMessagesEndFalcoEvent","FtsFetchEbMessagesPageEndFalcoEvent","FtsFetchEbMessagesPageStartFalcoEvent","FtsFetchEbMessagesStartFalcoEvent","FtsFetchOccamThreadsEndFalcoEvent","FtsFetchOccamThreadsPageEndFalcoEvent","FtsFetchOccamThreadsPageStartFalcoEvent","FtsFetchOccamThreadsStartFalcoEvent","MAWBridgeSendAndReceive","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set(),i=new Set(),j=null,k=!1,l=0,m=0;function a(){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(j!=null&&j!=="")return;j=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSRestoreSessionId"))});return n.apply(this,arguments)}function e(a,b,d){if(!b||i.has(a)){i.add(a);return}h.has(a)||(h.add(a),d&&c("FtsFetchEbMessagesStartFalcoEvent").log(function(){return{app_name:"",session_id:j!=null?j:""}}));c("FtsFetchEbMessagesPageStartFalcoEvent").log(function(){return{app_name:"",session_id:j!=null?j:""}})}function f(a,b,d){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:b.toString(),session_id:j!=null?j:""}});d||(i.add(a),c("FtsFetchEbMessagesEndFalcoEvent").log(function(){return{app_name:"",duration:0,session_id:j!=null?j:"",total_messages_count:"0"}}))}function o(a){if(i.has(a)||!h.has(a))return;c("FtsFetchEbMessagesPageEndFalcoEvent").log(function(){return{app_name:"",messages_count:"0",session_id:j!=null?j:""}})}function p(){c("FtsFetchOccamThreadsEndFalcoEvent").log(function(){return{app_name:"",duration:0,remaining_threads_count:m.toString(),session_id:j!=null?j:"",total_threads_count:l.toString()}})}function q(){k||(k=!0,c("FtsFetchOccamThreadsStartFalcoEvent").log(function(){return{app_name:"",session_id:j!=null?j:""}})),c("FtsFetchOccamThreadsPageStartFalcoEvent").log(function(){return{app_name:"",session_id:j!=null?j:""}})}function r(a){c("FtsFetchOccamThreadsPageEndFalcoEvent").log(function(){return{app_name:"",session_id:j!=null?j:"",thread_count:a.toString()}})}function s(a){l++,a||m++}g.initLoggingSessionId=a;g.onFetchMessagePageStart=e;g.onFetchMessagePageComplete=f;g.onFetchMessagePageFailed=o;g.onFetchThreadsComplete=p;g.onFetchThreadsPageStart=q;g.onFetchThreadsPageComplete=r;g.incrementTotalResultCount=s}),98);
__d("MWMediaRestoreQplUtils",["QPLFlow","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=18e4;function a(){var a=c("qpl")._(25304794,"2287");return d("QPLFlow").startQPLFlow(a,{timeoutInMs:h})}function b(){var a=c("qpl")._(25306381,"2492");return d("QPLFlow").startQPLFlow(a,{timeoutInMs:h})}g.startMediaRestoreBatchQPLFlow=a;g.startMediaRestoreLoadAllQPLFlow=b}),98);
__d("MAWFTSRestoreSync",["EventEmitter","FBLogger","I64","LSDatabaseSingleton","MAWAsyncEBIssueFetchAndIndexFTSQuery","MAWBridgeFireAndForget","MAWBridgeSearchMsg","MAWBridgeSendAndReceive","MAWDbMsg","MAWFTSIsMessageValidForSearch","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWLoggerUtils","MAWMediaGalleryRestoreSync","MWEncryptedBackUpEBNotEnabledError","MWMediaRestoreQplUtils","Promise","QPLFlow","WAPromiseDelays","WAResultOrError","asyncToGeneratorRuntime","cr:19810","err","getErrorSafe","isEbEnabledWithIGDEligibilityCheck","justknobx","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=new(c("EventEmitter"))(),l=(j||(j=d("I64"))).of_int32(c("justknobx")._("2477")),m=c("justknobx")._("2606"),n=c("uuidv4")();function o(a){return new(h||(h=b("Promise")))(function(b,d){return globalThis.setTimeout(function(){return d(c("err")("timeout"))},a)})}function p(){window.setInterval(function(){d("MAWBridgeFireAndForget").fireAndForget("backend","searchFTSReportTabAlive",{hasFocus:document.hasFocus(),tabId:n},!0)},1e3)}function q(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabTaskComplete",{error:a,tabId:n})});return r.apply(this,arguments)}function s(){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabDestroy",{tabId:n})});return t.apply(this,arguments)}function u(a){var b=200,c=12e4;return Math.min(b*Math.pow(3,a),c)}var v=function(){function a(a){a===void 0&&(a="search"),this.$1=!1,this.$2=!0,this.$3=!1,this.$4=!0,this.$5=void 0,this.$6={},this.$7=new Set(),this.$8=new Set(),this.$9=new Set(),this.$10=a,c("FBLogger")("fts_worker").info("New MAWFTSRestoreSync instance: "+a)}var e=a.prototype;e.setIsStarted=function(a){this.$1=a,this.$10==="media"&&k.emit("isSyncStarted",a)};e.setIsEBMaybeAvailable=function(a){this.$4=a,this.$10==="media"&&k.emit("isEBMaybeAvailable",a)};e.setActiveThreadId=function(a,c){c===void 0&&(c=!0),b("cr:19810")!=null&&c&&(a!=null&&b("cr:19810").getInstance().insertIntoHead(a)),this.$5=a,this.$10==="media"&&k.emit("activeThreadJid",a)};e.setShouldPauseRestore=function(a){this.$3=a};e.removeFromQueue=function(a){b("cr:19810")!=null&&a!=null&&b("cr:19810").getInstance().removeThread(a)};e.getActiveThreadId=function(){return this.$5};e.getNextThreadIdToFetch=function(){if(b("cr:19810")!=null){var a;return(a=b("cr:19810").getInstance().getThreadsHead())!=null?a:this.getActiveThreadId()}return this.getActiveThreadId()};e.getDoneThreads=function(){return this.$7};e.getDoneThreadsAfterReset=function(){return this.$9};e.getResetThreads=function(){return this.$8};e.isStarted=function(){return this.$1};e.isEBMaybeAvailable=function(){return this.$4};e.resetEBAvailability=function(){this.setIsEBMaybeAvailable(!0)};e.resetRestoreStatus=function(){var a=this,c=this.getActiveThreadId();return c!=null&&!this.$8.has(c)?d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSClearThreadRestoreStatus",{threadId:c},{isLoggingDisabled:!0}).then(function(){a.$8.add(c)}):(h||(h=b("Promise"))).resolve()};e.$11=function(a,b){var c=this;Object.keys(this.$6).forEach(function(d){c.$6[d](a,b)})};e.$12=function(a,c,e){return a!==c&&b("cr:19810")!=null?e==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(e,10)):e!=="0"};e.$13=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.setIsStarted(!0),this.setShouldPauseRestore(!1),yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:n},{isLoggingDisabled:!0}),window.addEventListener("focus",b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSReportTabForeground",{tabId:n},{isLoggingDisabled:!0})})),p()});function c(){return a.apply(this,arguments)}return c}();e.shouldLoop=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(this.$1||this.$4===!1)return!1;yield this.$13();a=(yield d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a));if(!a){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return!1}return!0});function c(b){return a.apply(this,arguments)}return c}();e.loadMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,i,j,k,p){var r=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:n,threadJid:e}));if(!r){yield d("WAPromiseDelays").delayMs(200);return"CONTINUE"}var t=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(a,e,f,l,g,k);if(t==null){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return"STOP"}var u=j();u.addAnnotations({"int":{retryCount:i},string:{restoreUntilMs:f!=null?f:""}});try{r=function(){return(h||(h=b("Promise"))).race([t,o(m)])};var v=(yield d("QPLFlow").QplSubspan.wrapInSubspan(u,"fetch_request",r));u.addAnnotations({"int":{numMessages:v.messages.length}});yield d("QPLFlow").QplSubspan.wrapInSubspan(u,"process_data",function(){return p(v,u)});u.endSuccess();yield q();return"CONTINUE"}catch(b){a=c("getErrorSafe")(b);if(a&&a.message===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){u.addPoint("eb_not_enabled");u.endCancel();this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);yield s();return"STOP"}if(a.message==="invalid-client-state")return"FAIL";c("FBLogger")("fts_worker").catching(a).mustfix("Fail to fetch a new batch of messages");u.endFail((e=a.message)!=null?e:"unknown");yield q(a);return"FAIL"}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.startSyncingLoopNew=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;this.setShouldPauseRestore(!1);var e=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);if(!(yield this.shouldLoop(e)))return;yield d("MAWFTSRestoreSyncLogger").initLoggingSessionId();var f=0,g=null,h=function*(){var h,i=a.getNextThreadIdToFetch(),k=a.getActiveThreadId();g!==i&&(g=i,f=0);if(i==null||b("cr:19810")==null&&a.$7.has(i)){yield d("WAPromiseDelays").delayMs(200);return 0}if(a.$3){yield d("WAPromiseDelays").delayMs(200);return 0}var l=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:i},{isLoggingDisabled:!0})),m=(h=l==null?void 0:l.restoredUntilSortOrderMs)!=null?h:null,n=l==null||l.restoredUntilSortOrderMs===l.maxRestoredUntilSortOrderMs||l.restoredUntilSortOrderMs==null;h=a.$12(i,k,m);if(!h){m==="0"&&(a.$7.add(i),a.$8.has(i)&&a.$9.add(i));a.removeFromQueue(i);yield d("WAPromiseDelays").delayMs(200);return 0}l=(yield a.loadMessages(e,i,m,function(){d("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(i,m==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(m,10)),n)},f,function(){return d("QPLFlow").startQPLFlow(c("qpl")._(25300854,"2397"))},"fts",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=b.messages;b=b.nextMessageTimestampMsBefore;b=b!=null?(j||(j=d("I64"))).to_string(b):"0";var e=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(b,10));d("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(i,c.length,e);a.$11(i,c);e=c.map(function(a){var b=d("MAWFTSIsMessageValidForSearch").verifyMessageValidity(a);return b==null?null:d("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers["extends"]({author:a.author,canonicalTs:d("MAWDbMsg").getCanonicalTsFromMsg(a),externalId:a.externalId,threadJid:i},b),!1)}).filter(Boolean);yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:b,threadId:i,unvaultedBridgeSearchMessages:e})});return function(a){return c.apply(this,arguments)}}()));$$gen$m0:{if(l==="CONTINUE"){f=0;break $$gen$m0}if(l==="FAIL"){d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);yield d("WAPromiseDelays").delayMs(u(f));f++;break $$gen$m0}if(l==="STOP"){return{v:void 0};break $$gen$m0}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+l)}},k;while(this.$2){k=(yield* h());if(k===0)continue;if(k)return k.v}});function e(){return a.apply(this,arguments)}return e}();e.startSyncingLoop=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this;if(c("justknobx")._("2435"))return this.startSyncingLoopNew();this.setShouldPauseRestore(!1);if(this.$1||this.$4===!1)return;yield this.$13();var e=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton),f=(yield d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(e));if(!f){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return}yield d("MAWFTSRestoreSyncLogger").initLoggingSessionId();var g=0,k=null;f=function*(){var f,i=a.getNextThreadIdToFetch(),o=a.getActiveThreadId();k!==i&&(k=i,g=0);if(i==null||b("cr:19810")==null&&a.$7.has(i)){yield d("WAPromiseDelays").delayMs(200);return 0}if(a.$3){yield d("WAPromiseDelays").delayMs(200);return 0}var p=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSGetThreadRestoreStatus",{threadId:i},{isLoggingDisabled:!0})),r=(f=p==null?void 0:p.restoredUntilSortOrderMs)!=null?f:null,t=p==null||p.restoredUntilSortOrderMs===p.maxRestoredUntilSortOrderMs||p.restoredUntilSortOrderMs==null;f=a.$12(i,o,r);if(!f){r==="0"&&(a.$7.add(i),a.$8.has(i)&&a.$9.add(i));a.removeFromQueue(i);yield d("WAPromiseDelays").delayMs(200);return 0}p=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:n,threadJid:i}));if(!p){yield d("WAPromiseDelays").delayMs(200);return 0}o=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(e,i,r,l,function(){d("MAWFTSRestoreSyncLogger").onFetchMessagePageStart(i,r==null||d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(r,10)),t)},"fts");if(o==null){a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);return{v:(h||(h=b("Promise"))).resolve()}}f=d("MAWLoggerUtils").getInstanceKey();p=d("QPLFlow").startQPLFlow(c("qpl")._(25300854,"2397"),{annotations:{"int":{retryCount:g},string:{restoreUntilMs:r!=null?r:""}},instanceKey:f});f=o.then(function(a){return d("WAResultOrError").makeResult(a)});try{o=(yield (h||(h=b("Promise"))).race([f,new h(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError("timeout"))},m)})]));if(o.success===!1){g++;p.endFail("timeout");d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages due to timeout");return 0}g=0;p.endSuccess();f=o.value;o=f.messages;f=f.nextMessageTimestampMsBefore;f=f!=null?(j||(j=d("I64"))).to_string(f):"0";var u=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(f,10));d("MAWFTSRestoreSyncLogger").onFetchMessagePageComplete(i,o.length,u);a.$11(i,o);u=o.map(function(a){var b=d("MAWFTSIsMessageValidForSearch").verifyMessageValidity(a);return b==null?null:d("MAWBridgeSearchMsg").createBridgeSearchMsg(babelHelpers["extends"]({author:a.author,canonicalTs:d("MAWDbMsg").getCanonicalTsFromMsg(a),externalId:a.externalId,threadJid:i},b),!1)}).filter(Boolean);yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchIndexUpdate",{newSortOrderMs:f,threadId:i,unvaultedBridgeSearchMessages:u})}catch(e){if(e&&(e==null?void 0:e.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){p.addPoint("eb_not_enabled");p.endCancel();a.setIsEBMaybeAvailable(!1);a.setIsStarted(!1);yield s();return{v:(h||(h=b("Promise"))).resolve()}}if((e==null?void 0:e.message)==="invalid-client-state")return 0;d("MAWFTSRestoreSyncLogger").onFetchMessagePageFailed(i);c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages with error %s",e==null?void 0:e.message);p.endFail((o=e==null?void 0:e.message)!=null?o:"unknown");yield q(e);return 0}yield q()};var o;while(this.$2){o=(yield* f());if(o===0)continue;if(o)return o.v}});function e(){return a.apply(this,arguments)}return e}();e.startMediaSyncingLoopNew=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,c=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton);if(!(yield this.shouldLoop(c)))return;var e=0,f=function*(){var f=a.getActiveThreadId();if(f==null||a.$7.has(f)){yield d("WAPromiseDelays").delayMs(200);return 0}if(a.$3){yield d("WAPromiseDelays").delayMs(200);return 0}var g=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:f},{isLoggingDisabled:!0}));g=(g=g==null?void 0:g.restoredUntilSortOrderMs)!=null?g:null;k.emit("restoredUntilMs",g!=null?parseInt(g,10):-1);var h=a.$12(f,f,g);if(!h){g==="0"&&a.$7.add(f);yield d("WAPromiseDelays").delayMs(200);return 0}h=(yield a.loadMessages(c,f,g,void 0,e,d("MWMediaRestoreQplUtils").startMediaRestoreBatchQPLFlow,"media",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a.nextMessageTimestampMsBefore!=null?(j||(j=d("I64"))).to_string(a.nextMessageTimestampMsBefore):"0";yield d("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(a,b);yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:c,threadId:f},{isLoggingDisabled:!0})});return function(b,c){return a.apply(this,arguments)}}()));$$gen$m1:{if(h==="CONTINUE"){e=0;break $$gen$m1}if(h==="FAIL"){yield d("WAPromiseDelays").delayMs(u(e));e++;break $$gen$m1}if(h==="STOP"){return{v:void 0};break $$gen$m1}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+h)}},g;while(this.$2){g=(yield* f());if(g===0)continue;if(g)return g.v}});function c(){return a.apply(this,arguments)}return c}();e.startMediaSyncingLoop=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("justknobx")._("2435"))return this.startMediaSyncingLoopNew();if(this.$1||this.$4===!1)return;yield this.$13();var a=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton),e=(yield d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a));if(!e){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return}e=0;while(this.$2){var f=this.getActiveThreadId();if(f==null||this.$7.has(f)){yield d("WAPromiseDelays").delayMs(200);continue}if(this.$3){yield d("WAPromiseDelays").delayMs(200);continue}var g=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getThreadMediaRestoreStatus",{threadId:f},{isLoggingDisabled:!0}));g=(g=g==null?void 0:g.restoredUntilSortOrderMs)!=null?g:null;k.emit("restoredUntilMs",g!=null?parseInt(g,10):-1);var o=this.$12(f,f,g);if(!o){g==="0"&&this.$7.add(f);yield d("WAPromiseDelays").delayMs(200);continue}o=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchFTSRequestRestoreTask",{tabId:n,threadJid:f}));if(!o){yield d("WAPromiseDelays").delayMs(200);continue}o=d("MAWAsyncEBIssueFetchAndIndexFTSQuery").issueQueryAsPromise(a,f,g,l,void 0,"media");if(o==null){this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);return(h||(h=b("Promise"))).resolve()}g=d("MWMediaRestoreQplUtils").startMediaRestoreBatchQPLFlow();g.addAnnotations({"int":{retry_count:e}});o=o.then(function(a){return d("WAResultOrError").makeResult(a)});try{g.addPoint("fetch_request_start");o=(yield (h||(h=b("Promise"))).race([o,new h(function(a){return window.setTimeout(function(){return a(d("WAResultOrError").makeError("timeout"))},m)})]));g.addPoint("fetch_request_end",{bool:{is_success:o.success===!0}});if(o.success===!1){e++;g.endFail("timeout");continue}e=0;var p=o.value.nextMessageTimestampMsBefore;p=p!=null?(j||(j=d("I64"))).to_string(p):"0";g.addPoint("handle_media_restore_start");yield d("MAWMediaGalleryRestoreSync").handleMediaRestoreSync(o.value,g);g.addPoint("handle_media_restore_end");yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","setThreadMediaRestoreStatus",{newSortOrderMs:p,threadId:f},{isLoggingDisabled:!0})}catch(a){if(a&&(a==null?void 0:a.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED){g.addPoint("eb_not_enabled");g.endCancel();this.setIsEBMaybeAvailable(!1);this.setIsStarted(!1);yield s();return(h||(h=b("Promise"))).resolve()}c("FBLogger")("fts_worker").mustfix("Fail to fetch a new batch of messages with error %s",a==null?void 0:a.message);g.endFail((o=a==null?void 0:a.message)!=null?o:"unknown");yield q(a);continue}yield q()}});function e(){return a.apply(this,arguments)}return e}();a.getInstance=function(){var b=a.instance;if(b!=null)return b;b=new a();a.instance=b;return b};a.getMediaInstance=function(){var b=a.mediaInstance;if(b!=null)return b;b=new a("media");a.mediaInstance=b;return b};a.resetInstance=function(){a.instance=null};e.setKeepWhileLoop_FOR_TESTING_ONLY=function(a){this.$2=a};return a}();v.instance=null;v.mediaInstance=null;function a(){return v.getInstance()}function e(){return v.getMediaInstance()}g.MAWGalleryEventEmitter=k;g.MAWFTSRestoreSync=v;g.getFTSRestoreSync=a;g.getMediaRestoreSync=e}),98);
__d("ThreadsDoublyLinkedList",[],(function(a,b,c,d,e,f){"use strict";var g=function(a){this.value=a};a=function(){function a(){this.$1=new Map(),this.$2=null,this.$3=null}var b=a.prototype;b.getHead=function(){if(this.$2!=null)return this.$2.value};b.has=function(a){return this.$1.has(a)};b.size=function(){return this.$1.size};b.insertToHead=function(a){if(this.getHead()===a)return;this.has(a)&&this.remove(a);this.$2==null?this.add(a):(this.$2.prev=new g(a),this.$2.prev.next=this.$2,this.$2=this.$2.prev,this.$1.set(a,this.$2))};b.add=function(a){if(this.has(a))return;if(!this.$2){this.$2=new g(a);this.$3=this.$2;this.$1.set(a,this.$2);return}this.$3!=null&&(this.$3.next=new g(a),this.$3.next.prev=this.$3,this.$3=this.$3.next,this.$1.set(a,this.$3))};b.remove=function(a){var b=this.$1.get(a);if(b==null)return;b.prev!=null&&(b.prev.next=b.next);b.next!=null&&(b.next.prev=b.prev);b===this.$2&&(this.$2=b.next);b===this.$3&&(this.$3=b.prev);this.$1["delete"](a)};return a}();f["default"]=a}),66);
__d("MAWFTSThreadsRestore",["FBLogger","I64","LSDatabaseSingleton","LSFactory","LSFetchFtsThreadsStoredProcedure","LSMessagingThreadTypeUtil","MAWBridgeSendAndReceive","MAWFTSRestoreCap","MAWFTSRestoreSyncLogger","MAWJids","ReQL","ThreadsDoublyLinkedList","WAJids","asyncToGeneratorRuntime","emptyFunction","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=function(){function a(){this.$1=new Map(),this.$4=!1,this.$5=(h||(h=d("I64"))).zero,this.$6=!1,this.$7=new Set(),c("FBLogger")("messenger_web").info("New MAWFTSThreadsRestore instance"),this.$2=new(c("ThreadsDoublyLinkedList"))()}var e=a.prototype;e.startThreadsRestore=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(this.$4)return;this.$4=!0;this.$6=!0;yield d("MAWFTSRestoreSyncLogger").initLoggingSessionId();yield this.$8();yield this.$9()});function c(){return a.apply(this,arguments)}return c}();e.isThreadQueryInProgress=function(){return this.$6||this.$7.size>0};e.getInitialLastActivityTimeForThreadMs=function(a){return this.$1.get(a)};e.getThreadsHead=function(){return this.$2.getHead()};e.hasThread=function(a){return this.$2.has(a)};e.insertIntoHead=function(a){this.$2.insertToHead(a)};e.removeThread=function(a){this.$2.remove(a)};e.$10=function(a,b){d("MAWFTSRestoreSyncLogger").onFetchThreadsPageStart(),void a.runInTransaction(function(a){return c("LSFetchFtsThreadsStoredProcedure")(c("LSFactory")(a),{sessionId:"",timestamp:b})},"readwrite",void 0,void 0,f.id+":123")};e.$11=function(a,b,e){e===void 0&&(e=c("emptyFunction"));this.$6=!0;var f=b.hasNextPage,g=b.nextPageCursor;b=b.resultCount;b=(h||(h=d("I64"))).to_int32(b);var i=!h.equal(g,this.$5),j=d("MAWFTSRestoreCap").isRestoreTimeWithinCap(h.to_float(g));i&&d("MAWFTSRestoreSyncLogger").onFetchThreadsPageComplete(b);f&&j?i&&(this.$5=g,this.$10(a,g)):(this.$6=!1,this.$7.size===0&&d("MAWFTSRestoreSyncLogger").onFetchThreadsComplete(),e())};e.$8=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield this.$12()),c=d("ReQL").fromTableAscending(b.tables.messenger_fts_threads_queries,["hasNextPage","nextPageCursor","resultCount"]),e={contents:function(){}};e.contents=c.subscribe(function(c,d){if(d.operation==="delete")return;a.$11(b,d.value,e.contents)});c=(yield d("ReQL").firstAsync(c));c?this.$11(b,c):this.$10(b,(h||(h=d("I64"))).max_int)});function c(){return a.apply(this,arguments)}return c}();e.$13=function(a){var b=this,e=a.nextMessageTimestamp,f=a.threadId;a=a.threadType;f=(h||(h=d("I64"))).to_string(f);a=d("LSMessagingThreadTypeUtil").isGroup(a);var g=a?d("WAJids").toGroupJid(f):d("MAWJids").toUserJid(f);this.$7.add(g);c("promiseDone")(d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchGetFTSNextTimestamp",{threadId:g}).then(function(a){var c=(h||(h=d("I64"))).to_float(e);if(!d("MAWFTSRestoreCap").isRestoreTimeWithinCap(c))return;if(!b.$1.has(g)){b.$1.set(g,c);c=a!=null&&!d("MAWFTSRestoreCap").isRestoreTimeWithinCap(parseInt(a,10));d("MAWFTSRestoreSyncLogger").incrementTotalResultCount(c)}if(a==="0")return;b.$2.add(d("WAJids").unsafeCoerceToChatJid(g));return d("MAWBridgeSendAndReceive").sendAndReceive("backend","searchSetFTSNextTimestamp",{newSortOrderMs:h.to_string(e),threadId:g})})["finally"](function(){b.$7["delete"](g),b.$7.size===0&&!b.$6&&d("MAWFTSRestoreSyncLogger").onFetchThreadsComplete()}))};e.$9=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=this,b=(yield this.$12());b=d("ReQL").fromTableAscending(b.tables.messenger_fts_threads,["threadId","nextMessageTimestamp","threadType"]);b.subscribe(function(b,c){c.operation==="add"&&a.$13(c.value)});b=(yield d("ReQL").toArrayAsync(b));b.forEach(function(b){a.$13(b)})});function c(){return a.apply(this,arguments)}return c}();e.$12=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){this.$3==null&&(this.$3=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton));return this.$3});function c(){return a.apply(this,arguments)}return c}();return a}();function a(){j==null&&(j=new k());return j}g.MAWFTSThreadsRestore=k;g.getInstance=a}),98);
;/*FB_PKG_DELIM*/

__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24052353867781136"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessageRangeQueryWithPersistence",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBDeriveAndStoreEpochs","EBGetClientState","EBMessageRangeQueryUtils","EBMessageRangeQueryWithPersistenceQuery.graphql","I64","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWJids","MAWJobDefinitions","MAWMiActGetThreadLifecycleState__DO_NOT_USE","MAWMiActThreadLifecycleState__DO_NOT_USE","QPLFlow","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),F=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),G=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),H=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),I=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");function a(a){return J.apply(this,arguments)}function J(){J=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,g=a.direction,h=a.includeOffset;h=h===void 0?!1:h;var p=a.numMessages,q=a.sortOrderMs,r=a.source,s=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var t=d("WAHashStringToNumber").hashStringToNumber(s),u=c("qpl")._(521471755,"2586"),v=d("QPLFlow").startQPLFlow(u,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},"int":{num_messages_requested:p,source:r!=null?r:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:t,timeoutInMs:c("justknobx")._("2950")});try{H.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""])),s,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(r,s,"GQL_MAIN_THREAD");var w=(yield (B||(B=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue()),x;yield w.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;v.addPoint("get_client_state_start");x=(yield d("EBGetClientState").getClientState(w,a));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(C||(C=d("I64"))).to_string((b=(b=x)==null?void 0:b.device_id)!=null?b:(C||(C=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:s});v.addPoint("get_client_state_end",{string:{device_id:C.to_string((b=(b=x)==null?void 0:b.device_id)!=null?b:(C||(C=d("I64"))).zero)}});b=(yield d("MAWMiActGetThreadLifecycleState__DO_NOT_USE").getThreadLifecycleStateByJid(a,d("MAWJids").convertChatJidToIntJid(e),"GQL_range_restore_eb_api_call"));if(b.type===d("MAWMiActThreadLifecycleState__DO_NOT_USE").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||b.type===d("MAWMiActThreadLifecycleState__DO_NOT_USE").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:s});v.addPoint("chat_jid_not_found_in_act_mapping_table");d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(s,!1);v.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:s}),v.addPoint("chat_jid_exists_in_act_mapping_table")});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":185");if(x==null){H.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"])));v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}u=x;t=u.backupId;a=u.device_id;var y=u.locally_available_epochs,z=u.mailboxRootKey;u=u.ocmfClientStateBlob;if(t==null||a==null||z==null||u==null){H.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"])));v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var A=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:s});v.addPoint("app_id_retrieved");var D=d("WAJids").threadIdForChatJid(e);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:s});v.addPoint("converted_chatjid_to_threadid");g=g==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;y={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(D),site:"www",tam_thread_subtype:0},success:babelHelpers["extends"]({device_context:{device_id:(C||(C=d("I64"))).to_string(a),locally_available_epochs:y,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(z),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(u)}},direction:g,include_offset:h,query_num_messages:p,server_thread_key:D},q!=null?{reference_timestamp:d("EBMessageRangeQueryUtils").safeTimestampMsString(q)}:{})};v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:s});var E;try{yield d("WorkerRelayNetwork").createWorkerNetworkExecute(),E=(yield d("WorkerRelay").createWorkerQuery(I,{app_id:String(A!=null?A:"0"),restore_payload_string:JSON.stringify(y),restore_type:"RANGE_QUERY_RESTORE"})),v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:s})}catch(a){z=c("getErrorSafe")(a);v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:z.stack}});return d("WAResultOrError").makeError("invalid-graphql-response")}if(E==null||((u=E)==null||(u=u.viewer)==null||(u=u.encrypted_backup)==null?void 0:u.mailbox)==null){v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=(g=E)==null||(g=g.viewer)==null||(g=g.encrypted_backup)==null||(g=g.mailbox)==null?void 0:g.messages;if(h==null){H.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"])));v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}p=h;if((p==null?void 0:p.encrypted_messages)==null){v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}D=p.backup_id;A=p.encrypted_messages;y=p.epoch_derivation_set;z=p.exception_string;u=p.message_range_info;g=p.should_delete_mailbox;h=p.thread_not_found;v.addAnnotations({bool:{should_delete_mailbox:g!=null?g:!1},"int":{response_messages:A.length},string:{message_range_info:JSON.stringify(u)}});if(z!=null){H.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""])),z);if(h!=null&&h){v.addPoint("thread_not_found_on_server");d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:s});v.endSuccess();d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(s,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}g===!0&&(v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:s}));v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:z}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:z}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);c("gkx")("7473")?yield d("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(w,y):yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(y,w,a,s);v.addAnnotations({bool:{hasEpochs:y!=null&&y.epoch_edges.length>0,nonLS:c("gkx")("7473")}});v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END);D==null&&(H.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]))),v.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:s}));p=(yield K(w,e,A,D!=null?D:(C||(C=d("I64"))).to_string(t),u,s,v));if(p.success===!1)return p;M(w,e,p.value,q,r,s);return d("WAResultOrError").makeResult()}catch(a){h=c("getErrorSafe")(a);H.ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""])),h);v.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(g=h.stack)!=null?g:""}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",h)}});return J.apply(this,arguments)}function K(a,b,c,d,e,f,g){return L.apply(this,arguments)}function L(){L=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,h,i,j,k){var l=d("WAJids").threadIdForChatJid(e),m=d("WAHashStringToNumber").hashStringToNumber(j),n=c("qpl")._(521471755,"2586");g.length===0&&(H.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No messages to restore"]))),k.addAnnotations({bool:{hasMessagesToRestore:!1}}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:j}));if(i==null){H.ERROR(q||(q=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"])));k.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}var o=i.has_more_after,B=i.has_more_before,C=i.next_message_timestamp_ms_after;i=i.next_message_timestamp_ms_before;if(B==null||o==null||C==null||i==null){H.ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"])));k.endFail(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}if(g.length===0){k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE);k.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:[],messageRangeInfo:{has_more_after:o,has_more_before:B,next_message_timestamp_ms_after:C,next_message_timestamp_ms_before:i},protobuf:[]})}h=d("handleRestoreMessagesGraphQLResponse").processMessageArray(g,h,n,m);var D=h.encryptedLSEchoMessages,E=h.encryptedMessagesWithProtobufs;n=h.encryptedNonLSEchoMessages;m=h.encryptedNonLSProtobufs;k.addAnnotations({bool:{hasEchoMessages:D.length>0,hasProtobufMessages:E.length>0}});if(c("gkx")("7473")){k.addPoint("native_decryption_start");h=d("WAJids").threadIdForChatJid(e);e=(yield d("EBAPIDecryptionModule").decryptUsingNativeJS(a,h,m,n));if(!e.success){k.endFail("native_decryption_error",{string:{error_description:"native_decryption_error"}});return d("WAResultOrError").makeError("native-decryption-error")}h=e.value.decryptedEchoMessages;e=e.value.decryptedProtobufs;h=d("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(h,e);k.addPoint("native_decryption_success");return d("WAResultOrError").makeResult({echo:c("LSVec").toArray(h.echo),messageRangeInfo:{has_more_after:o,has_more_before:B,next_message_timestamp_ms_after:C,next_message_timestamp_ms_before:i},protobuf:c("LSVec").toArray(h.protobuf)})}g.length!==D.length+E.length&&k.addAnnotations({bool:{hasEchoProtobufCountMismatch:!0}});H.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: "," nonLSProtobuf: ",""])),j,D.length,E.length,n.length,m.length);var F,G;if(D.length>0&&E.length>0){k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD);k.addAnnotations({"int":{echoMessagesPayloadSize:D.length,protobufMessagesPayloadSize:E.length,totalRestorePayloadSize:D.length+E.length}});k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START);e=(yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:l,encryptedMessages:c("LSVec").ofArray(D)})),e=b[0];b=b[1];if(b!=null){var f=d("LSShape").toRecord(b);H.ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."])));H.WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""])),f.error_message);k.addAnnotations({string:{echo_decryption_error:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error")}f=(yield c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:l,encryptedMessagesWithProtobufs:c("LSVec").ofArray(E)}));a=f[0];f=f[1];if(f!=null){f=d("LSShape").toRecord(f);H.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."])));H.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""])),f.error_message);k.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:f.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}f=a==null?0:c("LSVec").toArray(a).length;b!=null&&f>0&&k.addAnnotations({bool:{continuedAfterEchoDecryptFailure:!0}});return{decryptedEchoMsgs:e,decryptedProtobufMsgs:a}});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":768"));h=e.decryptedEchoMsgs;g=e.decryptedProtobufMsgs;k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END);var I;h!=null&&(I=c("LSVec").toArray(h).map(function(a){return d("LSShape").toRecord(a).value}));F=I;G=g==null?[]:c("LSVec").toArray(g)}else if(E.length===0){k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START);n=(yield a.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:l,encryptedMessages:c("LSVec").ofArray(D)})},"readwrite",void 0,void 0,f.id+":872"));m=n[0];e=n[1];if(e!=null){h=d("LSShape").toRecord(e);H.ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."])));H.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""])),h.error_message);k.endFail("ECHO_DECRYPTION_FAILURE",{string:{error_description:h.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,"ECHO_DECRYPTION_FAILURE",{string:{error_description:h.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END);if(m!=null){g=c("LSVec").toArray(m).map(function(a){return d("LSShape").toRecord(a).value});F=g}}else{k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START);n=(yield a.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:l,encryptedMessagesWithProtobufs:c("LSVec").ofArray(E)})},"readwrite",void 0,void 0,f.id+":921"));e=n[0];h=n[1];if(h!=null){m=d("LSShape").toRecord(h);H.ERROR(z||(z=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"])));H.WARN(A||(A=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""])),m.error_message);k.endFail("PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:m.error_message}});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(j,!1,"PROTOBUF_DECRYPTION_FAILURE",{string:{error_description:m.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}k.addPoint(d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END);G=e==null?[]:c("LSVec").toArray(e)}k.endSuccess();d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult({echo:F!=null?F:[],messageRangeInfo:{has_more_after:o,has_more_before:B,next_message_timestamp_ms_after:C,next_message_timestamp_ms_before:i},protobuf:G!=null?G:[]})});return L.apply(this,arguments)}function M(a,b,e,g,h,i){var j=e.echo,k=e.messageRangeInfo,l=e.protobuf,m=d("WAJids").threadIdForChatJid(b);j.length>0&&l.length>0?c("promiseDone")(E.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray(j),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)})):j.length>0?c("promiseDone")(F.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,(C||(C=d("I64"))).zero,c("LSVec").ofArray(j),k.has_more_before,C.of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,m,i,g,(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1010")})):c("promiseDone")(G.load().then(function(e){return a.runInTransaction(function(a){return e(a,0,m,c("LSVec").ofArray(l),k.has_more_before,(C||(C=d("I64"))).of_string(k.next_message_timestamp_ms_before),k.has_more_after,C.of_string(k.next_message_timestamp_ms_after),!1,i,g,void 0,c("LSVec").ofArray([]),(D||(D=d("LSIntEnum"))).ofNumber(h!=null?h:c("LSMEBTaskCreationSource").UNKNOWN),b)},"readwrite",void 0,void 0,f.id+":1033")}))}g.query=I;g.messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE=a}),98);
__d("EbFetchTimeoutMsForMLv2",["justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("justknobx")._("3074")}g["default"]=a}),98);
__d("LSEBUnifiedRestoreUtils",["CurrentUser","LSIntEnum","LSMEBTaskCreationSource","LSProtobufRestoreHandler","LSVec","MAWAsyncEBPendingQueryPromise","MAWBridgeSafeActionsWorkerAndUI","MAWEBRestoreTrackingUtils","MAWEBUnstoredDbMsgUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWJids","MAWJobDefinitions","MAWRestoreProtobufsFromEncryptedBackupsDeferred","MWEBODSEntityName.enum","MWEBODSUtils","Promise","WATagsLogger","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o;function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,p,q,r,s,t,u,v,w,x){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["starting eb restore - ",""])),s!=null?s:"no_request_id");d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,"unified_restore");var y=[].concat(d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(e));v=d("LSProtobufRestoreHandler").convertLSEchoMessageVecToArray(v);v=(yield d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:x,encodedEchoMessages:v}));y.push.apply(y,v);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(y,"protobuf_restore");if(s!=null)try{d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start_unified",traceId:s});v=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());v=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(y,a,void 0,v);if(f===!0&&v.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_decodedMessages_inconsistency",traceId:s});e=e!=null?c("LSVec").toArray(e).length:0;d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no decoded messages but hasMoreBefore is true, messages count after decryption: ",""])),e)}d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(s,{echoMessages:void 0,hasMoreAfter:p,hasMoreBefore:f,isPointQuery:r,messages:v,nextMessageTimestampMsBefore:g,protobufMessages:y,referenceTimestamp:t,requestId:s,restoreType:"protobuf",threadId:a})}catch(a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["eb restore native op - Failed to decode protobufs, with error: ",""])),a.message)}f===!0&&y.length===0&&(s!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"hasMoreBefore_messages_inconsistency",traceId:s}),d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - no messages but hasMoreBefore is true"]))));e=w!=null&&(o||(o=d("LSIntEnum"))).unwrapIntEnum(w)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(e){s!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"search_restore_end",traceId:s});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(s);return(n||(n=b("Promise"))).resolve()}v=w!=null&&(o||(o=d("LSIntEnum"))).unwrapIntEnum(w)===c("LSMEBTaskCreationSource").MSGR_DYI;if(v){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"])));yield d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWProtobufMessageRangeQueryRestore(a,y,f,g);s!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"dyi_restore_end",traceId:s});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(s);return(n||(n=b("Promise"))).resolve()}c("promiseDone")(d("MAWRestoreProtobufsFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(a),y,f,g,p,q,r,s,t,u,void 0,w,void 0,x),function(){s!=null&&d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_end_unified",traceId:s})},function(a){d("WATagsLogger").TAGS(["labyrinth_web","eb_restore",s!=null?s:"no_request_id"]).ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["eb restore nativeop - Failed to restore protobufs, with error: ",""])),a.message);a={string:{error:a.message}};s!=null&&d("MAWEBRestoreTrackingUtils").markEBRestoreFail(s,!1,"native_op_reject_unified",a)});return(n||(n=b("Promise"))).resolve()});return p.apply(this,arguments)}g.echoProtobufConsolidatedRestoreHelper=a}),98);
__d("MWRestoreMessagesFromEB",["EBIsEbEnabled","EBMessageRangeQueryWithPersistence","I64","MAWAsyncEBPendingQueryPromise","MAWMainTraceUtils","MWEncryptedBackUpEBNotEnabledError","Promise","WATagsLogger","err","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a){var e=a.chatJid,f=a.newerNumMessages,g=a.passedTraceId,k=a.sortOrderMs,l=a.source;a=a.storage;if(!c("gkx")("23914"))return null;var m=g!=null?g:d("MAWMainTraceUtils").createTraceId();c("promiseDone")(d("EBIsEbEnabled").isEbEnabledLS(a.tables).then(function(a){if(a)return d("EBMessageRangeQueryWithPersistence").messageRangeQueryWithPersistence_DEPRECATED_DO_NOT_USE({chatJid:e,direction:(j||(j=d("I64"))).to_float(f)>0?"after":"before",includeOffset:c("gkx")("5340"),sortOrderMs:(j||(j=d("I64"))).to_string(k),source:l,traceId:m}).then(function(a){a.success||d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(a.error))});else{d("WATagsLogger").TAGS(["labyrinth_web","eb_restore"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Issuing message range query for chatJid: "," skipped. EB not enabled"])),e);d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(m,c("err")(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED));return(i||(i=b("Promise"))).resolve()}}));return m}g["default"]=a}),98);
__d("MAWEBFetch",["EBFormatUtils","FBLogger","I64","LSMEBTaskCreationSource","MAWAsyncEBPendingQueryPromise","MWEncryptedBackUpEBNotEnabledError","MWRestoreMessagesFromEB","WAResultOrError","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;e=c("justknobx")._("3177");var i=Math.max(3,e-5);function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,i=a.timestampMs;a=a.traceId;e=d("EBFormatUtils").adjustCount(e,g);var j=e[0];e=e[1];b=c("MWRestoreMessagesFromEB")({chatJid:b,newerNumMessages:(h||(h=d("I64"))).of_int32(e),numMessages:h.of_int32(j),passedTraceId:a,sortOrderMs:d("EBFormatUtils").adjustTs(i,g),source:c("LSMEBTaskCreationSource").MESSENGER_MESSAGE_LIST_PAGINATION,storage:f});if(b==null)return d("WAResultOrError").makeResult({hasMoreAfter:!1,hasMoreBefore:!1,isEndOfCurrentFormat:!1,messages:[],restoreType:"none"});e=d("MAWAsyncEBPendingQueryPromise").getWaitForRestorePromiseFromTrace(b);j=(yield e.then(function(a){return d("WAResultOrError").makeResult(a)})["catch"](function(a){if(a&&(a==null?void 0:a.message)===d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED)return d("WAResultOrError").makeError(d("MWEncryptedBackUpEBNotEnabledError").EB_NOT_ENABLED);c("FBLogger")("messenger_web").catching(a).mustfix("[EBFetch] Failed to fetch");return d("WAResultOrError").makeError((a=a==null?void 0:a.message)!=null?a:"unknown")}));if(j.success===!1)return j;a=j.value;i=a.hasMoreAfter;f=a.hasMoreBefore;b=a.messages;e=a.restoreType;return d("WAResultOrError").makeResult({hasMoreAfter:i,hasMoreBefore:f,isEndOfCurrentFormat:k(g,i,f,b),messages:b,restoreType:e})});return j.apply(this,arguments)}function k(a,b,c,d){if(a==="before"&&c===!1)return!1;return a==="after"&&b===!1?!1:d.length<i}g["default"]=a}),98);
__d("MAWMessageIntegrityChecker",["FBLogger","MAWMessagesCompare","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){if(a.externalId===b.externalId)return 0;if(a.sortOrderMs>b.sortOrderMs)return 1;return a.sortOrderMs<b.sortOrderMs?-1:-1}function j(a,b){var c=b.reduce(function(a,b){b.externalId!=null&&a.set(b.externalId,b.sortOrderMs);return a},new Map());return a.map(function(a){var b;return babelHelpers["extends"]({},a,{sortOrderMs:(b=a.externalId!=null?c.get(a.externalId):null)!=null?b:a.sortOrderMs})}).sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"))}function k(a,b,c){a=new Set(a.map(function(a){return a.externalId}).filter(Boolean));return b.toSorted(d("MAWMessagesCompare").makeCompareMessageMetadataForDescOrderFn(a)).slice(0,c)}function a(a,b,d,e,f){var g=new Set(a.map(function(a){return a.externalId})),h=new Set(b.map(function(a){return a.externalId})),l=n(g,h);h=n(h,g);g=j(a,b);a=k(g,b,d);b=0;var m=0,o=0,p=0,q=[],r=null;while(b<g.length&&m<a.length){var s=g[b],t=a[m];if(r!=null&&i(t,r)===0){m+=1;r=t;c("FBLogger")("messenger_web_missing_messages").mustfix("Detected duplicate messages in reference. Target source: %s, reference source: %s",e,f);continue}var u=i(s,t);u===0?(b+=1,m+=1,r=t,q.push([s,{result:"consistent"}])):u<0?(m+=1,r=t,o+=1,q.push([t,{result:"missing_in_target"}])):(b+=1,p+=1,q.push([s,{result:"missing_in_reference"}]))}while(b<g.length){u=g[b];b+=1;a.length<d?(p+=1,q.push([u,{result:"missing_in_reference"}])):q.push([u,{result:"skipped_in_target"}])}while(m<a.length){t=a[m];m+=1;g.length<d?(o+=1,q.push([t,{result:"missing_in_target"}])):q.push([t,{result:"skipped_in_reference"}])}if(o===0&&p===0)return{detailedResults:q,result:"consistent",setDifferenceInReference:h,setDifferenceInTarget:l};else if(o>0&&p===0)return{detailedResults:q,numOfMissingMessages:o,result:"missing_in_target",setDifferenceInReference:h,setDifferenceInTarget:l};else if(o===0&&p>0)return{detailedResults:q,numOfMissingMessages:p,result:"missing_in_reference",setDifferenceInReference:h,setDifferenceInTarget:l};else return{detailedResults:q,numOfMissingMessages:p+o,result:"missing_in_both",setDifferenceInReference:h,setDifferenceInTarget:l}}function e(a,b,c){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,d,e){a=e.filter(function(a){a[0];a=a[1];return a.result==="missing_in_target"}).map(function(a){var b=a[0];a[1];return b.externalId});var f={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1},g=(yield d.fetchMessagesByExternalId(a,f)),i=new Set(g.map(function(a){return a.externalId}));return(h||(h=b("Promise"))).all(e.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a[0];a=a[1];if(!i.has(b.externalId))return[b,a];a=g.find(function(a){return a.externalId===b.externalId});if(!a){c("FBLogger")("messenger_web_missing_messages").mustfix("Failed to find msg with external id: %s in MAW",b.externalId);return[b,{result:"missing_in_target_invalid_sortOrder"}]}var d={sortOrderSkewMs:a.sortOrderMs-b.sortOrderMs,sortOrderSkewNumberOfMsg:0},e={result:"missing_in_target_invalid_sortOrder",sortOrderSkewMs:0};d.sortOrderSkewNumberOfMsg!=null&&(e=babelHelpers["extends"]({},e,{sortOrderSkewNumberOfMsg:d.sortOrderSkewNumberOfMsg}));return[babelHelpers["extends"]({},b,{msgType:a.msgType}),e]});return function(b){return a.apply(this,arguments)}}()))});return l.apply(this,arguments)}function f(a,b){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=b.filter(function(a){a[0];a=a[1];return a.result==="missing_in_target"}).map(function(a){var b=a[0];a[1];return b.externalId});if(c.length===0)return b;c=c.map(function(b){return d("ReQL").fromTableAscending(a.tables.messages.index("optimistic")).getKeyRange(b)});var e=c.length===1;c=c.length>1?d("ReQL").union.apply(void 0,c):c[0];var f=(yield d("ReQL").toArrayAsync(c));return b.map(function(a){var b=a[0];a=a[1];var c=f.find(function(a){return a.offlineThreadingId===b.externalId});if(c!=null)return[b,{result:"missing_in_target_exists_in_lsdb",transportKey:c.transportKey,wouldHaveThrownS518614:e}];a.wouldHaveThrownS518614=e;return[b,a]})});return m.apply(this,arguments)}function n(a,b){var c=0;for(a of a)b.has(a)||(c+=1);return c}g.checkIntegrityforMessageList=a;g.checkMsgsExistenceInMAWAndDecomposeTargetConsistencyResult=e;g.checkMsgsExistenceInLSDB=f}),98);
__d("MAWMessageIntegrityMissingInTargetCategory",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.hasEBFetchFailed,c=a.mawVsEB;a=a.uiVsEB;var d=i(a);a=c.detailedResults.filter(function(a){var b=a[0];a[1];return d.has(b.externalId)});return a.map(function(a){var c=a[0];a=a[1];a=h(c.externalId,a,b);return a==null?null:[c,a]}).filter(Boolean)}function h(a,b,d){switch(b.result){case"consistent":return"client_inconsistency";case"missing_in_target":return d?"eb_restore_timeout":"message_not_persisted_after_eb_restore";case"missing_in_target_invalid_sortOrder":return b.sortOrderSkewMs==null||b.sortOrderSkewMs===0?"message_out_of_order_same_timestamp":"message_out_of_order_different_timestamp";case"skipped_in_target":return"client_inconsistency_skipped";case"skipped_in_reference":return"unknown_skipped";case"missing_in_reference":case"missing_in_target_exists_in_lsdb":c("FBLogger")("messenger_web_missing_messages").mustfix("Unexpected consistency result %s for message with externalId %s when calculating missing in target category",b.result,a);return null;default:b.result;return null}}function i(a){return a.detailedResults.reduce(function(a,b){var c=b[0];b=b[1];b.result==="missing_in_target"&&a.add(c.externalId);return a},new Set())}g.calculateMissingInTargetCategory=a}),98);
__d("MAWMessageIntegrityCompareMessagesData",["I64","MAWMessageIntegrityChecker","MAWMessageIntegrityMissingInTargetCategory","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("WATagsLogger").TAGS(["MissingMessages"]);function a(a,b,c,d,e,f){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,d,e,f){var g=e.S518614_messagesBacktest,h=g.backendMessages,i=g.ebMessages,j=g.mpsMessages;g=g.uiMessages;var k=e.S518614_pageSizeBacktest,l=e.messages,m=l.backendMessages,o=l.ebMessages,p=l.mpsMessages;l=l.uiMessages;e=e.pageSize;m=(yield n(a,b,c,d,f,m,o,p,l,e));o=m.mawVsEB;p=m.missingInTargetCategory;l=m.mpsVsEB;var q=m.mpsVsMaw,r=m.uiVsEB;m=m.uiVsMaw;a=(yield n(a,b,c,d,f,h,i,j,g,k,!0));b=a.mawVsEB;c=a.mpsVsEB;d=a.mpsVsMaw;f=a.uiVsEB;h=a.uiVsMaw;i=a.wouldHaveThrownS518614;return{S518614_mawVsEB:b,S518614_mpsVsEB:c,S518614_mpsVsMaw:d,S518614_pageSize:k,S518614_uiVsEB:f,S518614_uiVsMaw:h,S518614_wouldHaveThrown:i,mawVsEB:o,missingInTargetCategory:p,mpsVsEB:l,mpsVsMaw:q,pageSize:e,uiVsEB:r,uiVsMaw:m}});return m.apply(this,arguments)}function n(a,b,c,d,e,f,g,h,i,j,k){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,m,n,o,q,r){r===void 0&&(r=!1);var s=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(o,g,q,"ui","maw"),t=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(o,m,q,"ui","eb"),u=d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(g,m,q,"maw","eb");g=n?d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(n,g,q,"mps","maw"):null;n=n?d("MAWMessageIntegrityChecker").checkIntegrityforMessageList(n,m,q,"mps","eb"):null;t.result!=="consistent"&&(!r?l.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Missing message detected for ",", result: ",", num of messages missing: ",""])),(k||(k=d("I64"))).to_float(e),t.result,t.numOfMissingMessages):l.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["S518614 backtest: Missing message detected for ",", result: ",", num of messages missing: ",""])),(k||(k=d("I64"))).to_float(e),t.result,t.numOfMissingMessages));(t.result==="missing_in_target"||t.result==="missing_in_both")&&(t.detailedResults=p(t.detailedResults,o));(u.result==="missing_in_target"||u.result==="missing_in_both")&&(u.detailedResults=(yield d("MAWMessageIntegrityChecker").checkMsgsExistenceInMAWAndDecomposeTargetConsistencyResult(c,b,u.detailedResults)));var v=!1;if(s.result==="missing_in_target"||s.result==="missing_in_both")try{s.detailedResults=(yield d("MAWMessageIntegrityChecker").checkMsgsExistenceInLSDB(a,s.detailedResults)),s.detailedResults.map(function(a){a[0];a=a[1];v||(v=a.wouldHaveThrownS518614===!0)})}catch(a){l.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to get detailed results for UI vs MAW comparison: ",""])),a)}m=d("MAWMessageIntegrityMissingInTargetCategory").calculateMissingInTargetCategory({hasEBFetchFailed:f,mawVsEB:u,uiVsEB:t});return{mawVsEB:u,missingInTargetCategory:m,mpsVsEB:n,mpsVsMaw:g,pageSize:q,uiVsEB:t,uiVsMaw:s,wouldHaveThrownS518614:v}});return o.apply(this,arguments)}function p(a,b){var c=new Set(b.map(function(a){return a.externalId}));return a.map(function(a){var b=a[0];a=a[1];return a.result==="missing_in_target"&&c.has(b.externalId)?[b,babelHelpers["extends"]({},a,{existingInUISamePage:!0})]:[b,a]})}g.compareMessagesData=a}),98);
__d("MAWMessageIntegrityFetchMessagesData",["I64","MAWBridgeSendAndReceive","MAWDbMsg","MAWEBDeanonFetch","MAWMessagesCompare","MAWMpsGating","MAWMpsMessageIntegrityFetch","MpsTypes","Promise","WAResultOrError","WAStanzaUtils","WATimeUtils","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,c,d,e,f){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g,h){var j=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","identifyXMAWithAssociatedTextByExternalId",{externalIds:h.map(function(a){return d("WAStanzaUtils").toStanzaId(a.offlineThreadingId)})})),l=h.map(o);a=(yield (i||(i=b("Promise"))).all([p(h),d("MAWMpsGating").isFullMpsEnabled()?[]:k(a,c,e,g,f),m(e,g,f),d("MAWMpsMessageIntegrityFetch").mpsMessageIntegrityFetch(e,"before",g,f)]));c=a[0];e=a[1];g=a[2];a=a[3];var n=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","identifyCollapsedMessagesByExternalId",{externalIds:g.map(function(a){return d("WAStanzaUtils").toStanzaId(a.externalId)})}));function q(a){return!j.includes(a.externalId)}function r(a){return!n.includes(a.externalId)}function s(a){return q(a)&&r(a)}var t=c.filter(s),u=e.filter(s),v=g.filter(s),w=a==null?null:a.filter(s);l=l.filter(s);s=h.length-l.length;h=f-s;if(v.length===0)return d("WAResultOrError").makeError("EB result not available");l=d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc");s=[].concat(u).sort(l).slice(0,h);u=[].concat(v).sort(l).slice(0,h);v=t.sort(l).slice(0,h);t=w!=null?[].concat(w).sort(l).slice(0,h):null;w=f;f=[].concat(e).sort(l).slice(0,w);e=[].concat(g).sort(l).slice(0,w);g=[].concat(c).sort(l).slice(0,w);c=a!=null?[].concat(a).sort(l).slice(0,w):null;return d("WAResultOrError").makeResult({S518614_messagesBacktest:{backendMessages:f,ebMessages:e,mpsMessages:c,uiMessages:g},S518614_pageSizeBacktest:w,messages:{backendMessages:s,ebMessages:u,mpsMessages:t,uiMessages:v},pageSize:h})});return j.apply(this,arguments)}function k(a,b,c,d,e){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){e=q(e);var g=e.msgId;e=e.timestampMs;b=(yield b.requestMessages(a,c,(h||(h=d("I64"))).of_float(e),g,"before",f,{admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1},"integrity"));return b.msgs});return l.apply(this,arguments)}function m(a,b,c){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var f=q(c),g=f.msgId;f=f.timestampMs;g=(yield g==null?(i||(i=b("Promise"))).resolve(null):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:g}));var h=(g=g==null?void 0:g.externalId)!=null?g:(g=c.lastItemFromPreviousPage)==null?void 0:g.offlineThreadingId;c=(yield d("MAWEBDeanonFetch").fetchMessagesMetadataFromEBDeanon({chatJid:a,count:e*2,direction:"before",includeReferenceTimestamp:!0,referenceExternalId:h,referenceTimestampMs:f}));if(c.success===!1)return[];g=c.value.sort(d("MAWMessagesCompare").getSortComparisonFunctionForDirection("desc"));a=g.findIndex(function(a){return a.externalId===h});return g.slice(a+1)});return n.apply(this,arguments)}function o(a){return{externalId:a.offlineThreadingId,msgType:(h||(h=d("I64"))).to_string(a.displayedContentTypes),sortOrderMs:h.to_float(a.primarySortKey)}}function p(a){var c=function(a){var c=d("MAWDbMsg").toMsgId(a.messageId);return c==null?(i||(i=b("Promise"))).resolve(o(a)):d("MAWBridgeSendAndReceive").sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:c}).then(function(b){return babelHelpers["extends"]({},a,{offlineThreadingId:(b=b==null?void 0:b.externalId)!=null?b:a.offlineThreadingId})}).then(o)};return(i||(i=b("Promise"))).all(a.map(c))}function q(a){if(a.type==="lastItemFromPreviousPage")return{messageId:d("MpsTypes").toMessageId(a.lastItemFromPreviousPage.offlineThreadingId),msgId:d("MAWDbMsg").toMsgId(a.lastItemFromPreviousPage.messageId),timestampMs:d("WATimeUtils").castToMillisTime((h||(h=d("I64"))).to_float(a.lastItemFromPreviousPage.primarySortKey))};a.type;return c("gkx")("15880")===!0?{messageId:null,msgId:null,timestampMs:a.timeOfSnapshotMs}:{messageId:null,msgId:null,timestampMs:d("WATimeUtils").millisTime()}}g.fetchMessagesDataForComparison=a;g.getRangeDetailsFromMessageIntegrityFromReference=q}),98);
__d("MAWMpsMessageIntegrityFetch",["MAWCurrentUser","MAWEBLSInWorkerSwitch","MAWEBSwitch","MAWMessageIntegrityFetchMessagesData","MAWMessagesDirection","MpsOverBridge","MpsTypes","Promise","WAPromiseDelays","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,d){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){f=d("MAWMessageIntegrityFetchMessagesData").getRangeDetailsFromMessageIntegrityFromReference(f);var i=f.messageId;f=f.timestampMs;c("MAWEBSwitch").isEnabled()===!0&&(yield (h||(h=b("Promise"))).race([d("WAPromiseDelays").delayMs(1e4),yield c("MAWEBLSInWorkerSwitch").waitForEBEnabled()]));e=(yield d("MpsOverBridge").mps().loadMessages({config:{shouldFetchSupplementals:!1,shouldIgnoreLocalOnly:!0,strategy:"full-fetch"},debug:{purpose:"integrity-check"},direction:d("MAWMessagesDirection").translateMawDirectionToMwpDirection(e),from:[d("MpsTypes").toTimestamp(f),i],numMessages:g*2,threadId:d("MpsTypes").toThreadId(a)}));return e.success===!1?null:e.value.messages.map(function(a){return{externalId:a.toplevelProtobuf.messageId,isOutgoing:a.toplevelProtobuf.senderId!==d("MAWCurrentUser").getID(),msgType:"",sortOrderMs:a.toplevelProtobuf.timestampMs}})});return i.apply(this,arguments)}g.mpsMessageIntegrityFetch=a}),98);
__d("MAWSecureDataSource",[],(function(a,b,c,d,e,f){"use strict";a=10;f.DEFAULT_NUM_MESSAGES=a}),66);
__d("MAWSecureLocalDBDataSource",["I64","MAWBridgeSendAndReceive","MAWDataSourceLogger","MAWDbMsg","MAWMessagesDirection","MAWMessagesPaginationUtils","MAWMiActOnActThreadReady","MAWPutMessagesToDB","MAWSecureDataSource","MAWSecureLocalDBFetch","MLV2DataSourceLogger","Promise","ReQL","WAStanzaUtils","WATagsLogger","asyncToGeneratorRuntime","err","isEbEnabledWithIGDEligibilityCheck","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=c("requireDeferred")("MAWEBFetch").__setRef("MAWSecureLocalDBDataSource"),o=d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]);function p(a){return a.msgs.map(function(a){return{externalId:a.externalId,isOptimistic:a.ack<1,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}})}a=function(){function a(){}var e=a.prototype;e.$1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,j,k,l,p,q,r){if(k==="after")return;k;o.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Fetch more: ",""])),e);d("MAWDataSourceLogger").logLoadMoreMsgsThreadWaiting(p,"before",e);k=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,e,"MAWSecureLocalDBDataSource"));k=k.chatJid;d("MAWDataSourceLogger").logLoadMoreMsgsThreadReadyFetchMsgs(p);d("MAWDataSourceLogger").logLoadMessagesFromLocalDBStart(p);var s=j.minMessageId,t=(yield d("MAWMessagesPaginationUtils").getExternalIdByMsgId(s));q=(yield c("MAWSecureLocalDBFetch")({actionType:q,chatJid:k,config:{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0},count:l,direction:"before",offsetMsg:{externalId:t,includeOriginalMsg:!1,messageId:s},timestampMs:g}));if(q.success===!1){throw(t=q.payload)!=null?t:c("err")(q.error)}var u=q.value;d("MAWDataSourceLogger").logLoadMessagesFromLocalDBEnd(p);d("MAWDataSourceLogger").logInsertMessageResponseToLSDBStart(p);d("MAWMessagesPaginationUtils").populateExternalIdCache(u.msgs);var v=u.msgs.length>0?u.msgs[u.msgs.length-1].msgId:j.minMessageId;yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c;yield d("MAWPutMessagesToDB").insertMessageResponseToDBInExistingTransaction(a,b,u,r,p);c=(yield (c=b.messages_ranges_v2__generated).get.apply(c,[j.threadKey,j.minTimestampMs,j.minMessageId]));if(c==null)return;var e=u.hasMoreBefore;u.hasMoreBefore===!1&&(yield d("isEbEnabledWithIGDEligibilityCheck").isEbEnabledWithIGDEligibilityCheck(a))&&(e=!0);yield b.messages_ranges_v2__generated.upsert([c.threadKey,c.minTimestampMs,c.minMessageId],{hasMoreAfter:!1,hasMoreBefore:e,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:c.maxMessageId,maxTimestampMs:c.maxTimestampMs,minMessageId:v,minTimestampMs:(m||(m=d("I64"))).zero,threadKey:j.threadKey})});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":146");d("MAWDataSourceLogger").logInsertMessageResponseToLSDBEnd(p);d("MAWDataSourceLogger").logLoadMoreMsgsFetched(p,u.hasMoreBefore);if(u.hasMoreBefore){d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p);return}s=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getMaybeNextNonAdminMsgSortOrderMs",{chatJid:k,mayBeAdminMsgId:d("MAWDbMsg").toMsgId(j.minMessageId)}));d("WATagsLogger").TAGS(["labyrinth_web","useFetchSecureMessages"]).LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["useFetchSecureMessages: threadJid: "," minMsgSortOrderTsResponse ",""])),k,s.minMsgTimestampMs);d("MAWDataSourceLogger").logLoadMoreMsgsRangeQuery(p,s.minMsgTimestampMs);g=(yield n.load());t=(yield g({chatJid:k,count:l,db:a,direction:"before",timestampMs:(m||(m=d("I64"))).of_float(s.minMsgTimestampMs)}));t.success&&t.value.hasMoreBefore===!1&&(yield a.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=j.minTimestampMs,f=(yield d("ReQL").firstAsync(d("ReQL").fromTableDescending(a.tables.messages_ranges_v2__generated).getKeyRange(e).bounds({lte:[c]}).filter(function(a){var b=a.maxTimestampMs;a=a.minTimestampMs;return(m||(m=d("I64"))).ge(c,a)&&(m||(m=d("I64"))).le(c,b)})));if(f==null)return;yield b.messages_ranges_v2__generated.upsert([f.threadKey,f.minTimestampMs,f.minMessageId],babelHelpers["extends"]({},f,{hasMoreBefore:!1,isLoadingBefore:!1}))});return function(a){return c.apply(this,arguments)}}(),"readwrite","ui",void 0,f.id+":231"));d("MAWDataSourceLogger").logLoadMoreMsgsSuccess(p)});function e(b,c,d,e,f,g,h,i,j){return a.apply(this,arguments)}return e}();e.requestMessages=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i,j){a=(yield d("MAWMessagesPaginationUtils").getExternalIdByMsgId(f));j=(yield c("MAWSecureLocalDBFetch")({actionType:j,chatJid:b,config:i,count:h!=null?h:d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES,direction:g,offsetMsg:f==null?null:{externalId:a,includeOriginalMsg:!1,messageId:f},timestampMs:e}));if(j.success===!1){throw(b=j.payload)!=null?b:c("err")(j.error)}i=j.value;d("MAWMessagesPaginationUtils").populateExternalIdCache(i.msgs);h=i.msgs.map(function(a){return{externalId:a.externalId,isOptimistic:a.ack<1,isOutgoing:a.isAuthorMe,msgType:a.type_,sortOrderMs:a.sortOrderMs}});return{hasMoreAfter:i.hasMoreAfter,hasMoreBefore:i.hasMoreBefore,msgs:h}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.fetchSecureMessagesProtocol=function(a,b,c,e,f,g,h,i,k){h===void 0&&(h=d("MAWSecureDataSource").DEFAULT_NUM_MESSAGES);c=d("MAWDataSourceLogger").logLoadMoreMsgsStart(c);return this.$1(a,b,e,f,g,h,c,i,k)["catch"](function(a){var c;o.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch messages: ",""])),a);(c=d("MLV2DataSourceLogger").getMLV2LoggerForThread(b,d("MAWMessagesDirection").translateMawDirectionToMwpDirection(g)))==null||c.markQPLFailure(a)})};e.fetchMessagesByExternalId=function(a,c){a.length>2&&o.WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Fetching "," messages by external id, which is not optimal.\n      Consider migrating 'loadMsgsByExternalId' backend request to a batch version "])),a.length);a=a.map(function(a){return d("MAWBridgeSendAndReceive").sendAndReceive("backend","loadMsgsByExternalId",{config:c,externalId:d("WAStanzaUtils").toStanzaId(a)})});return(l||(l=b("Promise"))).all(a).then(function(a){return a.map(function(a){return p(a)}).flat()})};return a}();g["default"]=a}),98);
__d("MAWMessageIntegrityFetchAndCompareData",["MAWMessageIntegrityCompareMessagesData","MAWMessageIntegrityFetchMessagesData","MAWMiActOnActThreadReady","MAWSecureLocalDBDataSource","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h=new(c("MAWSecureLocalDBDataSource"))();function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.db,c=a.fromReferencePoint,e=a.hasEbFetchFailed,f=a.localMessages,g=a.pageSize;a=a.threadKey;var i=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(b.tables,a,"fetchAndCompareMessagesData"));i=i.chatJid;g=(yield d("MAWMessageIntegrityFetchMessagesData").fetchMessagesDataForComparison(b,h,i,g,c,f));if(g.success===!1)return g;c=(yield d("MAWMessageIntegrityCompareMessagesData").compareMessagesData(b,h,i,a,g.value,e));return d("WAResultOrError").makeResult(c)});return i.apply(this,arguments)}g.fetchAndCompareMessagesData=a}),98);
__d("MAWMessagesIntegrityEphemeralSettings",["I64","MAWGetEphemeralSettings","MAWMiActOnActThreadReady","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"getIsEphemeralMessagesEnabledForPage"));a=a.chatJid;a=(yield d("MAWGetEphemeralSettings").getEphemeralSetting(a,b));if(a==null||a.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").DEFAULT_UNIXTIME)return"disabled";return d("WATimeUtils").castUnixTimeToMillisTime(a.ephemeralLastUpdatedOrSetTimestamp)<(h||(h=d("I64"))).to_float(c)?a.ephemeralExpirationInSec>0?"enabled":"disabled":a.ephemeralExpirationInSec>0?"maybeDisabled":"maybeEnabled"});return i.apply(this,arguments)}g.getEphemeralMessagesStatusForPage=a}),98);
__d("MAWMessageIntegrityCheck",["CometDebounce","DateConsts","EbFetchTimeoutMsForMLv2","I64","MAWBridgeSendAndReceive","MAWEBCombinedSwitch","MAWMessageIntegrityCheckFlytrapResultCache","MAWMessageIntegrityEBFetchStatus","MAWMessageIntegrityFetchAndCompareData","MAWMessageIntegrityTruncateStatus","MAWMessagesIntegrityEphemeralSettings","MAWMiActOnActThreadReady","WACommsConnectionState","WAPromiseDelays","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","gkx","justknobx","logMessengerWebFalcoEvent"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v="11",w=1e3*60*2,x=d("WATagsLogger").TAGS(["MissingMessages"]),y=c("CometDebounce")(c("logMessengerWebFalcoEvent"));function z(a){if(a.length===0)return null;var b=0;for(a of a)b=Math.max(b,(u||(u=d("I64"))).to_float(a.primarySortKey));return d("WATimeUtils").castToMillisTime(b)}function A(a,b){a=z(a);if(a==null)return b;var d=Math.abs(a-b),e=c("justknobx")._("4843");return d<e?a:b}function a(a,b,c,d,e,f,g,h,i,j){return B.apply(this,arguments)}function B(){B=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,z,B,E,H,J){x.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["run Message Integrity Check - threadKey: ",", lastItem: ",", pageSize: ",""])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),g);if(d("WATimeUtils").millisTime()-H>w){x.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: check was scheduled more than 2 minutes ago"])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey));return}var K=d("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled();if(z==null&&d("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&c("gkx")("15879")===!0){x.LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: WACOMMS is disconnected"])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey));return}var L=z==null&&c("gkx")("15880")===!0;if(L){var M=c("justknobx")._("4844"),N=H+M;N=Math.min(N-d("WATimeUtils").millisTime(),M);x.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check - threadKey "," - Latest Page - waiting ","ms"])),(u||(u=d("I64"))).to_string(b),N);yield d("WAPromiseDelays").delayMs(N)}M=d("WATimeUtils").millisTime();N=c("gkx")("1626");var O=d("MAWMessageIntegrityEBFetchStatus").hasEBFailure(b),P=d("MAWMessageIntegrityTruncateStatus").getThreadThuncateState(b),Q=z!=null?{lastItemFromPreviousPage:z,type:"lastItemFromPreviousPage"}:{timeOfSnapshotMs:A(B,H),type:"latestPageSnapshot"};Q=(yield d("MAWMessageIntegrityFetchAndCompareData").fetchAndCompareMessagesData({db:a,fromReferencePoint:Q,hasEbFetchFailed:O,localMessages:B,pageSize:g,threadKey:b}));if(Q.success===!1){x.LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check skipped for threadKey: ",", lastItem: ",", reason: ",""])),(u||(u=d("I64"))).to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),Q.error);return}g=Q.value;c("gkx")("4852")&&g.uiVsEB.detailedResults.some(function(a){a[0];a=a[1];return a==="missing_in_target"})&&J();Q=d("MAWMessageIntegrityCheckFlytrapResultCache").generateMessageIntegrityCheckPageKey(b,B);d("MAWMessageIntegrityCheckFlytrapResultCache").cacheMessageIntegrityCheckResult(Q,g.missingInTargetCategory);x.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against backend data: ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.uiVsMaw));x.LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", result against EB data: ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.uiVsEB));x.LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", MPS (target) vs MAW (reference): ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.mpsVsMaw));x.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check result - threadKey: ",", lastItem: ",", MPS (target) vs EB (reference): ",""])),u.to_string(b),z==null?"null":(u||(u=d("I64"))).to_float(z.primarySortKey),JSON.stringify(g.mpsVsEB));x.LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check Flytrap result - threadKey: ",", missingInTargetCategory: ",""])),u.to_string(b),JSON.stringify(g.missingInTargetCategory));x.LOG(r||(r=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check Truncate state - threadKey: ",", state: ",""])),u.to_string(b),JSON.stringify(P));J=D(g.mawVsEB);Q=D(g.uiVsEB);var R=D(g.uiVsMaw),S=g.mpsVsMaw!=null?D(g.mpsVsMaw):{},T=g.mpsVsEB!=null?D(g.mpsVsEB):{},U=D(g.S518614_mawVsEB),V=D(g.S518614_uiVsEB),W=D(g.S518614_uiVsMaw),X=g.S518614_mpsVsMaw!=null?D(g.S518614_mpsVsMaw):{},Y=g.S518614_mpsVsEB!=null?D(g.S518614_mpsVsEB):{};B=F(B);var Z=(yield d("MAWMessagesIntegrityEphemeralSettings").getEphemeralMessagesStatusForPage(a,b,B));a=(yield G(a,b));var $=(yield d("WAPromiseDelays").withTimeout(I({messages:[]})["catch"](function(a){x.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to get extra debug info: ",""])),a);return"error"}),1e4,function(){return"timeout"}));T={MAW_vs_EB_detailedResults:J.detailedResults,MAW_vs_EB_numOfMissingInReference:J.numOfMissingInReference,MAW_vs_EB_numOfMissingInTarget:J.numOfMissingInTarget,MAW_vs_EB_numOfMissingInTargetInvalidSortOrder:J.numOfMissingInTargetInvalidSortOrder,MAW_vs_EB_setNumOfMissingInReference:J.setDifferenceInReference,MAW_vs_EB_setNumOfMissingInTarget:J.setDifferenceInTarget,MPS_vs_EB_detailedResults:(J=T.detailedResults)!=null?J:"",MPS_vs_EB_numOfMissingInReference:(J=T.numOfMissingInReference)!=null?J:"",MPS_vs_EB_numOfMissingInTarget:(J=T.numOfMissingInTarget)!=null?J:"",MPS_vs_MAW_detailedResults:(T=S.detailedResults)!=null?T:"",MPS_vs_MAW_numOfMissingInReference:(J=S.numOfMissingInReference)!=null?J:"",MPS_vs_MAW_numOfMissingInTarget:(T=S.numOfMissingInTarget)!=null?T:"",S518614_MAW_vs_EB_detailedResults:(J=U.detailedResults)!=null?J:"",S518614_MPS_vs_EB_detailedResults:(S=Y.detailedResults)!=null?S:"",S518614_MPS_vs_MAW_detailedResults:(T=X.detailedResults)!=null?T:"",S518614_pageSize:g.S518614_pageSize.toString(),S518614_UI_vs_EB_detailedResults:(U=V.detailedResults)!=null?U:"",S518614_UI_vs_MAW_detailedResults:(J=W.detailedResults)!=null?J:"",S518614_wouldHaveThrown:C(g.S518614_wouldHaveThrown),UI_vs_EB_detailedResults:Q.detailedResults,UI_vs_EB_numOfMissingInReference:Q.numOfMissingInReference,UI_vs_EB_numOfMissingInTarget:Q.numOfMissingInTarget,UI_vs_EB_setNumOfMissingInReference:Q.setDifferenceInReference,UI_vs_EB_setNumOfMissingInTarget:Q.setDifferenceInTarget,UI_vs_MAW_detailedResults:R.detailedResults,UI_vs_MAW_numOfMissingInReference:R.numOfMissingInReference,UI_vs_MAW_numOfMissingInTarget:R.numOfMissingInTarget,UI_vs_MAW_setNumOfMissingInReference:R.setDifferenceInReference,UI_vs_MAW_setNumOfMissingInTarget:R.setDifferenceInTarget,ebMetadataCacheStatus:a,ebTimeoutSec:(c("EbFetchTimeoutMsForMLv2")()/d("DateConsts").MS_PER_SEC).toString(),endRangeTimestampMs:u.to_string(B),ephemeralMessagesStatus:Z+"",extraDebugInfo:$,hasAdditionalData:C(N),hasEBFetchFailed:C(O),integrityCheckScheduleTimestampMs:H.toString(),isDogfooding:C(c("gkx")("2972")),isEbEnabled:C(K),isEbGraphQL:K?"false":C(c("gkx")("7083")),isHoldout_H2_2025:C(c("gkx")("15728")),isJidOptimisationInRestoreEnabled:C(c("gkx")("3137")),isMpsEnabled:"true",isUsePageTimeForLatestPage:C(L),isUsingLsInitCache:C(c("gkx")("15958")),lastItemExternalId:(Y=z==null?void 0:z.offlineThreadingId)!=null?Y:"null",lastItemTimestamp:u.to_string((S=z==null?void 0:z.primarySortKey)!=null?S:(u||(u=d("I64"))).zero),missingInTargetCategory:JSON.stringify(g.missingInTargetCategory),pageIndex:E+"",pageSize:g.pageSize+"",reportTimeMs:M.toString(),truncateState:(X=JSON.stringify(P))!=null?X:"null",version:K?v:"0",waCommsIsConnected:C(d("WACommsConnectionState").WACommsConnectionState.isConnected())};c("gkx")("970")&&x.DEV(t||(t=babelHelpers.taggedTemplateLiteralLoose(["Message Integrity Check - Falco Report"]))).devConsole({falcoReport:T});y({threadKey:b,threadType:e},"message_integrity_check",f,T)});return B.apply(this,arguments)}function C(a){return a===!0?"true":"false"}function D(a){var b=0,c=0,d=0;a.detailedResults.forEach(function(a){a[0];a=a[1];switch(a.result){case"missing_in_target":case"missing_in_target_exists_in_lsdb":b+=1;break;case"missing_in_target_invalid_sortOrder":c+=1;b+=1;break;case"missing_in_reference":d+=1;break;case"consistent":case"skipped_in_target":case"skipped_in_reference":break;default:a.result}});return{detailedResults:E(a.detailedResults),numOfMissingInReference:d+"",numOfMissingInTarget:b+"",numOfMissingInTargetInvalidSortOrder:c+"",setDifferenceInReference:a.setDifferenceInReference+"",setDifferenceInTarget:a.setDifferenceInTarget+""}}function E(a){a=a.map(function(a){var b=a[0];a=a[1];var d=a.existingInUISamePage,e=a.result,f=a.sortOrderSkewMs;a=a.sortOrderSkewNumberOfMsg;return babelHelpers["extends"]({existingInUISamePage:d,externalId:b.externalId,isOutgoing:b.isOutgoing},c("gkx")("1626")?{msgType:b.msgType,sortOrderMs:b.sortOrderMs}:{},{result:e,sortOrderSkewMs:f!=null?f:0,sortOrderSkewNumberOfMsg:a!=null?a:0})});return JSON.stringify(a)}function F(a){return a.length===0?(u||(u=d("I64"))).min_int:a.map(function(a){return a.timestampMs}).sort((u||(u=d("I64"))).compare)[0]}function G(a,b){return H.apply(this,arguments)}function H(){H=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=(yield d("MAWMiActOnActThreadReady").waitForACTThreadReady(a.tables,b,"fetchAndCompareMessagesData"));b=a.chatJid;a=(yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getEBMetadataCacheDetailsForThread",{chatJid:b}));return JSON.stringify(a)});return H.apply(this,arguments)}function I(a){return J.apply(this,arguments)}function J(){J=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a={browser:{loadEventEnd:window.performance.timing.loadEventEnd,navigationStart:window.performance.timing.navigationStart},worker:yield d("MAWBridgeSendAndReceive").sendAndReceive("backend","getWorkerBasedMessageIntegrityDebugInfo",a)};return JSON.stringify(a)});return J.apply(this,arguments)}e={runMessageIntegrityCheck:a};g["default"]=e}),98);